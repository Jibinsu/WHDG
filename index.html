<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Chosen: Command Bunker</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="The Chosen">
    <link rel="apple-touch-icon" href="https://img.icons8.com/color/48/biohazard.png">

    <style>
        :root {
            --bg-color: #eaedf0; --surface-color: #ffffff; --text-color: #1c1e21;
            --text-sub: #606770; --header-bg: #2c3e50; --header-text: #ffffff;
            --accent-color: #2980b9; --border-color: #dfe3e8;
            --console-bg: #1a1a1a; --stat-bg: #f8f9fa; --stat-header: #e9ecef;
            --highlight-bg: #e8f5e9; --highlight-border: #c8e6c9;
            
            --kw-pos: #2e7d32; --kw-neg: #c62828; --kw-spec: #6a1b9a;
            --strat-dg: #27ae60; --strat-core: #7f8c8d;
            --warning-bg: #fff3e0; --warning-border: #ffe0b2; --warning-text: #e65100;
        }

        body.dark-mode {
            --bg-color: #121212; --surface-color: #1e1e1e; --text-color: #e0e0e0;
            --text-sub: #a0a0a0; --header-bg: #000000; --header-text: #27ae60;
            --accent-color: #27ae60; --border-color: #333333; --console-bg: #000000;
            --stat-bg: #2c2c2c; --stat-header: #3a3a3a;
            --highlight-bg: #1b3a1e; --highlight-border: #2e7d32;
            --warning-bg: #3e2723; --warning-border: #e65100; --warning-text: #ffcc80;
            
            --kw-pos: #66bb6a; --kw-neg: #ef5350; --kw-spec: #ab47bc;
        }

        html, body {
            height: 100%; margin: 0; overflow: hidden; background-color: var(--bg-color);
            color: var(--text-color); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            font-size: 14px; line-height: 1.4; -webkit-tap-highlight-color: transparent;
            transition: background-color 0.3s, color 0.3s;
        }

        #app-container { display: flex; flex-direction: column; height: 100%; }

        /* --- Top Bar --- */
        #phase-tracker {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 15px; background-color: var(--header-bg); color: var(--header-text);
            height: 55px; flex-shrink: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.3); z-index: 10;
        }
        .phase-info { display: flex; flex-direction: column; }
        .turn-label { font-size: 0.65rem; opacity: 0.8; letter-spacing: 1px; text-transform: uppercase; }
        #current-phase-name { font-size: 1.1rem; font-weight: 900; text-transform: uppercase; }
        
        #contagion-badge {
            background: var(--kw-pos); color: #fff; font-size: 0.7rem; padding: 2px 6px;
            border-radius: 4px; margin-left: 8px; vertical-align: middle; display: none;
        }

        .header-controls { display: flex; gap: 10px; align-items: center; }
        
        #next-phase-btn {
            background-color: var(--accent-color); color: #fff; border: none;
            padding: 8px 16px; border-radius: 6px; font-weight: 700; cursor: pointer;
            font-size: 0.85rem; transition: all 0.2s;
        }
        
        #theme-toggle {
            background: transparent; border: 1px solid rgba(255,255,255,0.3); color: var(--header-text);
            width: 36px; height: 36px; border-radius: 50%; cursor: pointer; display: grid; place-items: center; font-size: 1.2rem;
        }

        /* --- Body --- */
        #main-body { display: flex; flex-grow: 1; overflow: hidden; position: relative; }
        
        #unit-list {
            width: 260px; flex-shrink: 0; background-color: var(--stat-bg); 
            border-right: 1px solid var(--border-color); overflow-y: auto; padding: 10px; padding-bottom: 130px;
        }
        .group-label { font-size: 0.7rem; font-weight: 900; color: var(--text-sub); margin: 15px 0 5px 6px; text-transform: uppercase; letter-spacing: 0.5px; }
        .unit-btn {
            display: block; width: 100%; padding: 12px 12px; margin-bottom: 6px;
            background: var(--surface-color); border: 1px solid var(--border-color); border-radius: 8px;
            text-align: left; font-weight: 700; color: var(--text-color); cursor: pointer;
            font-size: 0.9rem; position: relative; transition: all 0.2s;
        }
        .unit-btn.active { background-color: var(--accent-color); color: #fff; border-color: var(--accent-color); transform: translateX(4px); }
        .unit-btn.rules-btn { border-left: 5px solid var(--highlight-border); }
        .unit-btn.combo-btn { border-left: 5px solid var(--accent-color); }
        
        #unit-details-wrapper { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; background: var(--bg-color); }
        #content-scroll { flex-grow: 1; overflow-y: auto; padding: 15px; padding-bottom: 130px; display: flex; flex-direction: column; gap: 15px; }

        /* --- Stratagem Bar --- */
        #strat-bar {
            background: var(--header-bg); border-top: 1px solid rgba(255,255,255,0.1);
            padding: 8px 10px; display: flex; gap: 10px; overflow-x: auto;
            white-space: nowrap; flex-shrink: 0; height: 50px; align-items: center;
            -webkit-overflow-scrolling: touch;
        }
        #strat-bar::-webkit-scrollbar { display: none; }
        .strat-pill {
            color: #fff; padding: 6px 12px; border-radius: 6px;
            font-size: 0.75rem; font-weight: bold; border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 2px 4px rgba(0,0,0,0.3); flex-shrink: 0; cursor: pointer;
        }
        .strat-pill.dg { background: var(--strat-dg); }
        .strat-pill.core { background: var(--strat-core); }

        /* --- Console --- */
        #command-console {
            height: 65px; background-color: var(--console-bg); color: #f1f1f1;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; box-shadow: 0 -2px 15px rgba(0,0,0,0.5); flex-shrink: 0; z-index: 20;
        }
        .console-group { display: flex; align-items: center; gap: 20px; }
        .resource-box { display: flex; flex-direction: column; align-items: center; min-width: 50px; }
        .res-label { font-size: 0.6rem; color: #888; font-weight: bold; letter-spacing: 1px; }
        .res-val { font-size: 1.6rem; font-weight: 900; line-height: 1; color: var(--accent-color); }
        .res-controls { display: flex; gap: 8px; margin-top: 2px; }
        .res-btn {
            background: #333; color: #fff; border: 1px solid #555; width: 28px; height: 28px;
            border-radius: 6px; font-weight: bold; cursor: pointer; display: grid; place-items: center;
        }
        .reset-btn { font-size: 0.7rem; color: #e74c3c; background: transparent; border: 1px solid #e74c3c; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: bold; }

        /* --- Cards & Stats --- */
        .card { background: var(--surface-color); border-radius: 8px; padding: 15px; border: 1px solid var(--border-color); box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: all 0.3s; }
        .card.battleshock-active { border: 2px solid var(--warning-text); background: var(--warning-bg); }
        
        .tactics-card { background-color: var(--highlight-bg); border: 1px solid var(--highlight-border); color: var(--text-color); }
        .tactics-card h3 { margin-top: 0; color: var(--kw-pos); border-bottom: 1px solid var(--highlight-border); padding-bottom: 5px; margin-bottom: 10px; font-size: 1rem; }
        .tactics-detail { font-size: 0.9rem; line-height: 1.5; }

        .split-view { display: flex; gap: 15px; flex-wrap: wrap; }
        .split-col { flex: 1; min-width: 300px; display: flex; flex-direction: column; gap: 10px; }

        .unit-header { display: flex; justify-content: space-between; border-bottom: 1px solid var(--border-color); padding-bottom: 8px; margin-bottom: 10px; align-items: center; }
        .unit-title { color: var(--accent-color); font-size: 1.1rem; font-weight: 900; }
        .unit-role { font-size: 0.7rem; background: var(--stat-bg); padding: 4px 8px; border-radius: 4px; font-weight: bold; color: var(--text-sub); }

        .stats-row { display: flex; gap: 1px; background: var(--border-color); border-radius: 6px; overflow: hidden; margin-bottom: 12px; }
        .stat-box { flex: 1; background: var(--surface-color); text-align: center; padding: 6px 0; }
        .stat-label { font-size: 0.6rem; font-weight: 800; color: var(--text-sub); display: block; }
        .stat-val { font-size: 1.1rem; font-weight: 800; color: var(--text-color); }
        .invuln-box { background: var(--header-bg); } .invuln-box .stat-val { color: #fff; }

        .wound-control { display: flex; align-items: center; justify-content: space-between; background: var(--stat-bg); padding: 6px 10px; border-radius: 6px; margin-bottom: 5px; border: 1px solid var(--border-color); }
        .wound-btn { width: 32px; height: 32px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--surface-color); color: var(--text-color); font-weight: bold; cursor: pointer; display: grid; place-items: center; font-size: 1.2rem; touch-action: manipulation; }
        .wound-val { font-size: 1.3rem; font-weight: 800; width: 40px; text-align: center; color: var(--text-color); }
        
        .weapon-row { margin-bottom: 10px; border-bottom: 1px dashed var(--border-color); padding-bottom: 8px; }
        .weapon-name { font-weight: 800; color: var(--text-color); font-size: 0.95rem; margin-bottom: 4px; display: block;}
        .profile-table { width: 100%; font-size: 0.9rem; text-align: center; border-collapse: collapse; border: 1px solid var(--border-color); margin-top: 4px; }
        .profile-table th { background: var(--stat-header); color: var(--text-sub); padding: 4px; font-size: 0.7rem; text-transform: uppercase; }
        .profile-table td { padding: 6px; font-weight: 600; color: var(--text-color); border: 1px solid var(--border-color); }

        .ability { margin-bottom: 8px; padding-left: 10px; border-left: 4px solid var(--border-color); }
        .ability-name { font-weight: 800; color: var(--text-color); font-size: 0.9rem; }
        .ability-desc { font-size: 0.85rem; color: var(--text-sub); margin-top: 2px; }
        
        .active-phase { border-color: var(--highlight-border); background: var(--highlight-bg); }
        .enhancement { border-color: #9b59b6; background: rgba(155, 89, 182, 0.1); }
        .deadly-demise { color: var(--kw-neg); font-weight: 900; display: none; text-align: center; font-size: 0.85rem; margin-top: 8px; animation: pulse 1s infinite; text-transform: uppercase; letter-spacing: 1px; }
        .battleshock { display: none; text-align: center; font-size: 0.8rem; color: var(--warning-text); font-weight: 800; margin-top: 5px; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body class="">

<div id="app-container">
    <div id="phase-tracker">
        <div class="phase-info">
            <span id="turn-display" class="turn-label">SETUP</span>
            <div>
                <span id="current-phase-name">DEPLOYMENT</span>
                <span id="contagion-badge">3" AURA</span>
            </div>
        </div>
        <div class="header-controls">
            <button id="theme-toggle" onclick="toggleTheme()">‚óê</button>
            <button id="next-phase-btn">START GAME</button>
        </div>
    </div>

    <div id="main-body">
        <aside id="unit-list"></aside>
        <div id="unit-details-wrapper">
            <div id="content-scroll"></div>
        </div>
    </div>

    <div id="strat-bar">
        <span style="color:rgba(255,255,255,0.5); font-size:0.8rem;">Awaiting Deployment...</span>
    </div>

    <div id="command-console">
        <div class="console-group">
            <button class="reset-btn" onclick="resetGame()">RESET</button>
        </div>
        <div class="console-group">
            <div class="resource-box">
                <span class="res-label">CP</span>
                <span class="res-val" id="cp-val">0</span>
                <div class="res-controls">
                    <div class="res-btn" onclick="modRes('cp', -1)">-</div>
                    <div class="res-btn" onclick="modRes('cp', 1)">+</div>
                </div>
            </div>
            <div class="resource-box" style="margin-left: 10px; border-left: 1px solid #555; padding-left: 15px;">
                <span class="res-label">VP</span>
                <span class="res-val" id="vp-val" style="color: #f1c40f;">0</span>
                <div class="res-controls">
                    <div class="res-btn" onclick="modRes('vp', -1)">-</div>
                    <div class="res-btn" onclick="modRes('vp', 5)">+5</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- 1. GAME DATA ---
    const PROFILES = {
        loc: {
            name: `Lord of Contagion`,
            stats: { M: '5"', T: '6', Sv: '2+', W: '6', Ld: '6+', OC: '1', invuln: '4+' },
            wargear: [
                { name: `Manreaper (Strike)`, type: `Melee`, stats: { range: `Melee`, a: `5`, ws: `2+`, s: `9`, ap: `-2`, d: `3` }, kw: `LETHAL HITS` },
                { name: `Manreaper (Sweep)`, type: `Melee`, stats: { range: `Melee`, a: `10`, ws: `2+`, s: `6`, ap: `-1`, d: `1` }, kw: `LETHAL HITS` }
            ],
            abilities: [
                { name: `Vector of Disease`, desc: `While this model is leading a unit, melee weapons equipped by models in that unit have the <strong>[SUSTAINED HITS 1]</strong> and <strong>[LANCE]</strong> abilities.`, phases: [`fight`] },
                { name: `Unholy Resilience`, desc: `The first time this model is destroyed, roll one D6 at the end of the phase. On a 2+, set this model back up on the battlefield, as close as possible to where it was destroyed and not within Engagement Range of any enemy units, with 3 wounds remaining.`, phases: [`any`] },
                { name: `ENHANCEMENT: Warprot Talisman`, desc: `Once per battle, at the end of your opponent‚Äôs turn, if the bearer‚Äôs unit is not within Engagement Range of one or more enemy units, you can remove it from the battlefield and place it into Strategic Reserves.`, phases: [`opponent_end`] }
            ]
        },
        lov: {
            name: `Lord of Virulence`,
            stats: { M: '5"', T: '6', Sv: '2+', W: '6', Ld: '6+', OC: '1', invuln: '4+' },
            wargear: [
                { name: `Twin Plague Spewer`, type: `Ranged`, stats: { range: `12"`, a: `D6`, bs: `N/A`, s: `5`, ap: `-1`, d: `1` }, kw: `ANTI-INF 2+, IGNORES COVER, TORRENT, TWIN-LINKED` },
                { name: `Power Fist`, type: `Melee`, stats: { range: `Melee`, a: `5`, ws: `2+`, s: `8`, ap: `-2`, d: `2` }, kw: `LETHAL HITS` }
            ],
            abilities: [
                { name: `Virulent Aura`, desc: `While this model is leading a unit, each time a model in that unit makes a ranged attack, you can re-roll the Wound roll.`, phases: [`shooting`, `opp_shooting`] },
                { name: `Blight Bombardment`, desc: `At the start of your Shooting phase, select one enemy unit within 30" of and visible to this model. Until the end of the phase, friendly DEATH GUARD Blast weapons re-roll the Hit roll. Other friendly DEATH GUARD weapons re-roll a Hit roll of 1.`, phases: [`shooting`] },
                { name: `ENHANCEMENT: Helm of Fly King`, desc: `While the bearer is leading a unit, models in that unit cannot be targeted by ranged attacks unless the attacking model is within 18".`, phases: [`opp_shooting`] }
            ]
        },
        typhus: {
            name: `Typhus`,
            stats: { M: '5"', T: '6', Sv: '2+', W: '6', Ld: '6+', OC: '1', invuln: '4+' },
            wargear: [
                { name: `Lakrimae (Strike)`, type: `Melee`, stats: { range: `Melee`, a: `6`, ws: `2+`, s: `9`, ap: `-2`, d: `3` }, kw: `LETHAL HITS` },
                { name: `Lakrimae (Sweep)`, type: `Melee`, stats: { range: `Melee`, a: `12`, ws: `2+`, s: `6`, ap: `-1`, d: `1` }, kw: `LETHAL HITS` }
            ],
            abilities: [
                { name: `Destroyer Hive`, desc: `While this model is leading a unit, each time a melee attack targets that unit, subtract 1 from the Hit roll.`, phases: [`fight`, `opp_fight`] },
                { name: `Eater Plague (Psychic)`, desc: `In your Shooting phase, select one enemy unit within 18" of and visible to this PSYKER. Roll one D6: <br>1: This PSYKER‚Äôs unit suffers D3 mortal wounds.<br>2-5: That enemy unit suffers D6 mortal wounds.<br>6: That enemy unit suffers D3+3 mortal wounds.`, phases: [`shooting`] }
            ]
        },
        deathshroud: {
            name: `Deathshroud Terms`,
            stats: { M: '5"', T: '6', Sv: '2+', W: '4', Ld: '6+', OC: '1', invuln: '4+' },
            wargear: [
                { name: `Plaguespurt Gauntlet`, type: `Ranged`, stats: { range: `12"`, a: `D6`, bs: `N/A`, s: `3`, ap: `0`, d: `1` }, kw: `ANTI-INF 4+, IGNORES COVER, PISTOL, TORRENT` },
                { name: `Manreaper (Strike)`, type: `Melee`, stats: { range: `Melee`, a: `4`, ws: `2+`, s: `8`, ap: `-2`, d: `2` }, kw: `LETHAL HITS` },
                { name: `Manreaper (Sweep)`, type: `Melee`, stats: { range: `Melee`, a: `8`, ws: `3+`, s: `4`, ap: `-1`, d: `1` }, kw: `LETHAL HITS` }
            ],
            abilities: [
                { name: `Silent Bodyguard`, desc: `While a CHARACTER model is leading this unit, that CHARACTER model has the Feel No Pain 4+ ability.`, phases: [`any`] },
                { name: `Death Approaches`, desc: `In your Movement phase, when this unit is set up on the battlefield using the Deep Strike ability, it can be set up anywhere on the battlefield that is more than 6" horizontally away from all Afflicted enemy units.`, phases: [`movement`] },
                { name: `Icon of Despair`, desc: `While an enemy unit is within 6" of the bearer, worsen the Leadership characteristic of models in that unit by 1.`, phases: [`aura`] }
            ]
        },
        poxwalkers: {
            name: `Poxwalkers`,
            stats: { M: '4"', T: '4', Sv: '7+', W: '1', Ld: '8+', OC: '1', invuln: '6+' },
            wargear: [ { name: `Improvised Weapon`, type: `Melee`, stats: { range: `Melee`, a: `2`, ws: `5+`, s: `3`, ap: `0`, d: `1` }, kw: `LETHAL HITS` } ],
            abilities: [
                { name: `Curse of the Walking Pox`, desc: `Each time a POXWALKER model in this unit makes an attack that destroys an enemy model (excluding MONSTER and VEHICLE models), after this unit has resolved its attacks, you can return one destroyed POXWALKER model to this unit. (Typhus kills count).`, phases: [`fight`] },
                { name: `Feel No Pain 5+`, desc: `Core ability.`, phases: [`any`] }
            ]
        },
        blightlords: {
            name: `Blightlord Terms`,
            stats: { M: '5"', T: '6', Sv: '2+', W: '3', Ld: '6+', OC: '1', invuln: '4+' },
            wargear: [
                { name: `Blight Launcher`, type: `Ranged`, stats: { range: `24"`, a: `D3`, bs: `3+`, s: `6`, ap: `-1`, d: `2` }, kw: `BLAST, LETHAL HITS` },
                { name: `Reaper Autocannon`, type: `Ranged`, stats: { range: `36"`, a: `4`, bs: `3+`, s: `7`, ap: `-1`, d: `1` }, kw: `DEV WOUNDS, SUSTAINED 1` },
                { name: `Combi-bolter`, type: `Ranged`, stats: { range: `24"`, a: `2`, bs: `3+`, s: `4`, ap: `0`, d: `1` }, kw: `LETHAL, RAPID FIRE 2` }
            ],
            abilities: [
                { name: `Blistering Fusillade`, desc: `If this unit has a Starting Strength of 5 or more, or if a CHARACTER is leading this unit, then each time a model in this unit makes a ranged attack that targets an Afflicted unit, improve the Strength and Armour Penetration characteristics of that attack by 1.`, phases: [`shooting`, `opp_shooting`] }
            ]
        },
        spawn: {
            name: `Chaos Spawn`,
            stats: { M: '8"', T: '5', Sv: '4+', W: '4', Ld: '7+', OC: '1', invuln: '5+' },
            wargear: [ { name: `Hideous Mutations`, type: `Melee`, stats: { range: `Melee`, a: `D6+2`, ws: `4+`, s: `5`, ap: `-1`, d: `2` }, kw: `` } ],
            abilities: [ { name: `Lethal Ichor`, desc: `Each time a melee attack is allocated to a model in this unit, after the attacking unit has finished making its attacks, roll one D6 (to a maximum of six D6 per attacking unit): for each 4+, the attacking unit suffers 1 mortal wound.`, phases: [`fight`, `opp_fight`] }, { name: `FNP 5+`, desc: ``, phases: [`any`] } ]
        },
        drone: {
            name: `Foetid Bloat-drone`,
            stats: { M: '10"', T: '9', Sv: '3+', W: '10', Ld: '6+', OC: '3', invuln: '5+' },
            wargear: [ { name: `Heavy Blight Launcher`, type: `Ranged`, stats: { range: `36"`, a: `D6+2`, bs: `3+`, s: `10`, ap: `-2`, d: `3` }, kw: `BLAST, LETHAL HITS` } ],
            abilities: [ { name: `Explosive Blight`, desc: `In your Shooting phase, each time this model makes an attack that destroys an enemy unit, before removing the last model in that unit from play, roll a D6, adding 1 to the result if that unit is Afflicted: on a 5+, each enemy unit within 6" of that model is Afflicted until the start of your next turn.`, phases: [`shooting`] }, { name: `Deadly Demise D3`, desc: ``, phases: [`any`] } ]
        },
        pbc: {
            name: `Plagueburst Crawler`,
            stats: { M: '10"', T: '10', Sv: '2+', W: '12', Ld: '6+', OC: '3', invuln: '5+' },
            wargear: [ { name: `Plagueburst Mortar`, type: `Ranged`, stats: { range: `48"`, a: `D6+3`, bs: `3+`, s: `8`, ap: `-1`, d: `2` }, kw: `BLAST, INDIRECT, LETHAL` }, { name: `Entropy Cannon`, type: `Ranged`, stats: { range: `36"`, a: `1`, bs: `3+`, s: `10`, ap: `-3`, d: `D6+1` }, kw: `LETHAL HITS` } ],
            abilities: [ { name: `Spore-laced Shock Waves`, desc: `In your Shooting phase, each time you select a target for this model‚Äôs Plagueburst mortar, roll one D6 for the target unit and every other enemy unit within 3" of the target unit, adding 1 to that roll if the unit being rolled for is Afflicted. On a 6+, the unit being rolled for is struck by spores; after resolving all of this model‚Äôs attacks against the target unit, each unit struck by spores suffers D3 mortal wounds.`, phases: [`shooting`] } ]
        }
    };

    const TASK_FORCES = [
        {
            id: 'rules', name: 'üìú ARMY RULES', group: 'Reference',
            type: 'rules',
            content: `
                <div class="card tactics-card">
                    <h3>Skullsquirm Blight (Army Rule)</h3>
                    <div class="tactics-detail">
                    <p><strong>Effect:</strong> If your Army Faction is DEATH GUARD, while an enemy unit is within Contagion Range of one or more DEATH GUARD models from your army, it is <strong>Afflicted</strong>.</p>
                    <p><strong>Debuff:</strong> While an enemy unit is Afflicted, subtract 1 from the Toughness characteristic of models in that unit.</p>
                    <p><strong>Skullsquirm Effect:</strong> Each time a model in this unit makes an attack, subtract 1 from the Hit roll.</p>
                    <div style="margin-top:15px; background:rgba(0,0,0,0.05); padding:8px; border-radius:4px; text-align:center; font-weight:bold;">
                        CONTAGION RANGE<br>
                        Turn 1: 3" &nbsp;|&nbsp; Turn 2: 6" &nbsp;|&nbsp; Turn 3+: 9"
                    </div>
                    </div>
                </div>
                <div class="card tactics-card" style="margin-top:15px;">
                    <h3>Deadly Vectors (Detachment)</h3>
                    <div class="tactics-detail">
                    <p>In your opponent‚Äôs Command phase, roll 2D6 for each Afflicted enemy unit, subtracting 1 from the result if that unit is Below Half-strength.</p>
                    <p>If the result is <strong>6 or less</strong>, that enemy unit suffers <strong>D3 mortal wounds</strong>.</p>
                    </div>
                </div>
            `
        },
        {
            id: 'tf_executioner', name: '‚öîÔ∏è EXECUTIONER BLOCK', group: 'Task Forces',
            type: 'combo',
            tactics: {
                title: 'THE MELEE BLENDER',
                desc: '<strong>The Interaction:</strong> The Lord of Contagion grants the unit <strong>[Vector of Disease]</strong>. This provides <strong>[Sustained Hits 1]</strong> (Exploding 6s) and <strong>[Lance]</strong> (+1 to Wound on the charge).<br><br><strong>The Math:</strong> Deathshroud Scythes are Strength 8.<br>- With Lance, they become S8 +1 to Wound.<br>- Wound T4 (Marines) on 2+.<br>- Wound T5-T8 (Elites) on 2+.<br>- Wound T9-T15 (Tanks/Knights) on 4+.<br><br>Combined with 6 models (approx 25 attacks) + Sustained Hits, this unit mathematically destroys almost any target in one phase.'
            },
            units: [ { profile: 'loc', count: 1, label: 'Warlord' }, { profile: 'deathshroud', count: 6, label: 'Bodyguard' } ]
        },
        {
            id: 'tf_spotter', name: 'üéØ ARTILLERY SPOTTER', group: 'Task Forces',
            type: 'combo',
            tactics: {
                title: 'SPOT & OVERWATCH',
                desc: '<strong>Spotting:</strong> In your Shooting Phase, use the LoV ability <strong>Blight Bombardment</strong> first. Select a visible enemy within 30". Your Plagueburst Crawlers (and all Blast weapons) now <strong>re-roll Hits</strong> against that target.<br><br><strong>Overwatch Threat:</strong> The LoV grants <strong>Re-roll Wounds</strong> to his unit. Deathshroud Gauntlets are <strong>Anti-Infantry 4+</strong>. If Infantry move within 12", fire Overwatch. You hit on 6s, but you auto-wound on 4+ (Criticals) and re-roll failed wounds. This melts infantry.'
            },
            units: [ { profile: 'lov', count: 1, label: 'Leader' }, { profile: 'deathshroud', count: 3, label: 'Bodyguard' } ]
        },
        {
            id: 'tf_tarpit', name: 'üßü THE TAR PIT', group: 'Task Forces',
            type: 'combo',
            tactics: {
                title: 'THE RESURRECTION LOOP',
                desc: '<strong>The Loop:</strong><br>1. In your Shooting Phase, Typhus uses <strong>Eater Plague</strong>. If he kills models, use <strong>Curse of the Walking Pox</strong> to return destroyed Poxwalkers.<br>2. In the Fight Phase, Poxwalkers attack. Kills return Poxwalkers.<br>3. Typhus attacks. Kills return Poxwalkers.<br><br><strong>Durability:</strong> Typhus gives the unit -1 to be Hit in Melee. They have FNP 5+.'
            },
            units: [ { profile: 'typhus', count: 1, label: 'Leader' }, { profile: 'poxwalkers', count: 10, label: 'Bodyguard' } ]
        },
        { id: 'sq_blight', name: 'üõ°Ô∏è ANVIL (Blightlords)', group: 'Solo Operatives', type: 'single', profile: 'blightlords', count: 5 },
        { id: 'sq_ds_solo', name: 'üíÄ ACTION (Deathshroud)', group: 'Solo Operatives', type: 'single', profile: 'deathshroud', count: 3 },
        { id: 'veh_pbc1', name: 'üí• PBC 1', group: 'Vehicles', type: 'single', profile: 'pbc', count: 1 },
        { id: 'veh_pbc2', name: 'üí• PBC 2', group: 'Vehicles', type: 'single', profile: 'pbc', count: 1 },
        { id: 'veh_drone1', name: 'ü¶ü DRONE 1', group: 'Vehicles', type: 'single', profile: 'drone', count: 1 },
        { id: 'veh_drone2', name: 'ü¶ü DRONE 2', group: 'Vehicles', type: 'single', profile: 'drone', count: 1 },
        { id: 'veh_spawn', name: 'üëπ SPAWN (2)', group: 'Vehicles', type: 'single', profile: 'spawn', count: 2 }
    ];

    const PHASES = [
        { id: 'command', label: 'My Command', cp: true }, 
        { id: 'movement', label: 'My Move' }, { id: 'shooting', label: 'My Shoot' },
        { id: 'charge', label: 'My Charge' }, { id: 'fight', label: 'My Fight' },
        { id: 'opp_command', label: 'Opp Command', cp: true }, 
        { id: 'opp_movement', label: 'Opp Move' }, { id: 'opp_shooting', label: 'Opp Shoot' },
        { id: 'opp_charge', label: 'Opp Charge' }, { id: 'opp_fight', label: 'Opp Fight' },
        { id: 'opponent_end', label: 'End Opp Turn' }
    ];

    const STRATAGEMS = {
        command: [
            { name: `Blooming Pestilence (1CP)`, desc: `<strong>WHEN:</strong> Your Command phase.<br><strong>TARGET:</strong> One DEATH GUARD unit from your army.<br><strong>EFFECT:</strong> Until the start of your next Command phase, the Contagion Range of models in your unit is increased by 3".`, type: 'dg' },
            { name: `Signal Pox (1CP)`, desc: `<strong>WHEN:</strong> Your Command phase.<br><strong>TARGET:</strong> One enemy unit that is visible to a DEATH GUARD model from your army.<br><strong>EFFECT:</strong> Until the start of your next Command phase, that enemy unit is Afflicted.`, type: 'dg' },
            { name: `Command Re-roll (1CP)`, desc: `<strong>WHEN:</strong> Any phase, just after you have made a Hit roll, a Wound roll, a Damage roll, a saving throw, an Advance roll, a Charge roll, a Desperate Escape test, a Hazardous test, or just after you have rolled the dice to determine the number of attacks made with a weapon, for a unit from your army.<br><strong>EFFECT:</strong> You re-roll that roll, test or saving throw.`, type: 'core' },
            { name: `New Orders (1CP)`, desc: `<strong>WHEN:</strong> Your Command phase.<br><strong>TARGET:</strong> One unit from your army that is within range of an objective marker you control.<br><strong>EFFECT:</strong> That objective marker remains under your control, even if you have no models within range of it, until your opponent controls it at the start or end of any turn.`, type: 'core' },
            { name: `Insane Bravery (1CP)`, desc: `<strong>WHEN:</strong> Battle-shock step of your Command phase, just after you have failed a Battle-shock test for a unit from your army.<br><strong>TARGET:</strong> The unit that failed that test.<br><strong>EFFECT:</strong> Your unit is treated as having passed that test.`, type: 'core' }
        ],
        movement: [
            { name: `Blooming Pestilence (1CP)`, desc: `<strong>WHEN:</strong> Your Command phase (Active during Movement).<br><strong>EFFECT:</strong> Aura ranges +3".`, type: 'dg' },
             { name: `Rapid Ingress (1CP)`, desc: `<strong>WHEN:</strong> End of your opponent's Movement phase.<br><strong>TARGET:</strong> One unit from your army that is in Reserves.<br><strong>EFFECT:</strong> Your unit can arrive on the battlefield as if it were the Reinforcements step of your Movement phase.`, type: 'core' }
        ],
        shooting: [
            { name: `Mortarions Teachings (1CP)`, desc: `<strong>WHEN:</strong> Start of your Shooting phase.<br><strong>TARGET:</strong> One DEATH GUARD unit from your army.<br><strong>EFFECT:</strong> Until the end of the phase, ranged weapons equipped by models in your unit have the [SUSTAINED HITS 1] ability. If such a weapon already has this ability, until the end of the phase, each time an attack is made with that weapon, a Critical Hit is scored on an unmodified Hit roll of 5+ instead of 6.`, type: 'dg' },
            { name: `Grenade (1CP)`, desc: `<strong>WHEN:</strong> Your Shooting phase.<br><strong>TARGET:</strong> One GRENADES unit from your army that is not within Engagement Range of any enemy units and has not been selected to shoot this phase.<br><strong>EFFECT:</strong> Select one enemy unit that is not within Engagement Range of any units from your army and is within 8" of and visible to your unit. Roll six D6: for each 4+, that enemy unit suffers 1 mortal wound.`, type: 'core' },
            { name: `Command Re-roll (1CP)`, desc: `<strong>EFFECT:</strong> Re-roll one die.`, type: 'core' }
        ],
        charge: [
            { name: `Sickening Impact (1CP)`, desc: `<strong>WHEN:</strong> Charge phase, just after a DEATH GUARD unit from your army ends a Charge move.<br><strong>TARGET:</strong> That DEATH GUARD unit.<br><strong>EFFECT:</strong> Select one enemy unit within Engagement Range of your unit and roll one D6 for each model in your unit: for each 4+, that enemy unit suffers 1 mortal wound.`, type: 'dg' },
            { name: `Tank Shock (1CP)`, desc: `<strong>WHEN:</strong> Charge phase.<br><strong>TARGET:</strong> One VEHICLE unit from your army.<br><strong>EFFECT:</strong> Select one enemy unit within Engagement Range of your unit and select one melee weapon your unit is equipped with. Roll a number of D6 equal to that weapon's Strength characteristic. If that Strength characteristic is greater than that enemy unit's Toughness characteristic, roll two additional D6. For each 5+, that enemy unit suffers 1 mortal wound (to a maximum of 6 mortal wounds).`, type: 'core' }
        ],
        fight: [
            { name: `Grim Reapers (1CP)`, desc: `<strong>WHEN:</strong> Fight phase.<br><strong>TARGET:</strong> One BLIGHTLORD TERMINATORS or DEATHSHROUD TERMINATORS unit from your army that has not been selected to fight this phase.<br><strong>EFFECT:</strong> Until the end of the phase, each time a model in your unit makes an attack, you can re-roll the Hit roll.`, type: 'dg' },
            { name: `Undying Spite (1CP)`, desc: `<strong>WHEN:</strong> Fight phase, just after an enemy unit has selected its targets.<br><strong>TARGET:</strong> One DEATH GUARD CHARACTER unit from your army that was selected as the target of one or more of the attacking unit's attacks.<br><strong>EFFECT:</strong> Until the end of the phase, each time a model in your unit is destroyed, if that model has not fought this phase, do not remove it from play. The destroyed model can fight after the attacking model‚Äôs unit has finished making its attacks, and is then removed from play.`, type: 'dg' },
            { name: `Epic Challenge (1CP)`, desc: `<strong>WHEN:</strong> Fight phase, when a CHARACTER unit from your army that is within Engagement Range of one or more attached units is selected to fight.<br><strong>TARGET:</strong> One CHARACTER model in your unit.<br><strong>EFFECT:</strong> Until the end of the phase, all melee attacks made by that model have the [PRECISION] ability.`, type: 'core' },
            { name: `Counter-Offensive (2CP)`, desc: `<strong>WHEN:</strong> Fight phase, just after an enemy unit has fought.<br><strong>TARGET:</strong> One unit from your army that is within Engagement Range of one or more enemy units and that has not fought this phase.<br><strong>EFFECT:</strong> Your unit fights next.`, type: 'core' }
        ],
        opp_movement: [
            { name: `Rapid Ingress (1CP)`, desc: `<strong>WHEN:</strong> End of your opponent's Movement phase.<br><strong>TARGET:</strong> One unit from your army that is in Reserves.<br><strong>EFFECT:</strong> Your unit can arrive on the battlefield as if it were the Reinforcements step of your Movement phase.`, type: 'core' },
            { name: `Fire Overwatch (1CP)`, desc: `<strong>WHEN:</strong> Your opponent's Movement or Charge phase, just after an enemy unit is set up or when an enemy unit starts or ends a Normal, Advance, Fall Back or Charge move.<br><strong>TARGET:</strong> One unit from your army that is within 24" of that enemy unit and that would be eligible to shoot if it were your Shooting phase.<br><strong>EFFECT:</strong> Your unit can shoot that enemy unit as if it were your Shooting phase. Until the end of the phase, each time a model in your unit makes a ranged attack, an unmodified Hit roll of 6 is required to score a hit, irrespective of any modifiers.`, type: 'core' }
        ],
        opp_shooting: [
            { name: `Smokescreen (1CP)`, desc: `<strong>WHEN:</strong> Your opponent's Shooting phase, just after an enemy unit has selected its targets.<br><strong>TARGET:</strong> One SMOKE unit from your army that was selected as the target of one or more of the attacking unit's attacks.<br><strong>EFFECT:</strong> Until the end of the phase, your unit has the Benefit of Cover and the Stealth ability.`, type: 'core' },
            { name: `Go To Ground (1CP)`, desc: `<strong>WHEN:</strong> Your opponent's Shooting phase, just after an enemy unit has selected its targets.<br><strong>TARGET:</strong> One INFANTRY unit from your army that was selected as the target of one or more of the attacking unit's attacks.<br><strong>EFFECT:</strong> Until the end of the phase, models in your unit have a 6+ invulnerable save and have the Benefit of Cover.`, type: 'core' }
        ],
        opp_charge: [
             { name: `Heroic Intervention (2CP)`, desc: `<strong>WHEN:</strong> Your opponent's Charge phase, just after an enemy unit ends a Charge move.<br><strong>TARGET:</strong> One unit from your army that is within 6" of that enemy unit and would be eligible to declare a charge.<br><strong>EFFECT:</strong> Your unit now declares a charge that targets only that enemy unit, and you resolve that charge as if it were your Charge phase. Your unit does not receive any Charge bonus this turn.`, type: 'core' },
             { name: `Fire Overwatch (1CP)`, desc: `<strong>WHEN:</strong> Start or End of Charge move.<br><strong>EFFECT:</strong> Shoot on 6s.`, type: 'core' }
        ],
        opp_fight: [
             { name: `Counter-Offensive (2CP)`, desc: `<strong>WHEN:</strong> Fight phase, just after an enemy unit has fought.<br><strong>EFFECT:</strong> Interrupt fight order.`, type: 'core' }
        ]
    };

    // --- 3. STATE MANAGEMENT (PERSISTENCE) ---
    const STATE_KEY = 'dg_chosen_final_v6';
    
    let gameState = {
        turn: 0, cp: 0, vp: 0, phaseIdx: -1,
        activeId: 'rules', wounds: {},
        theme: 'light'
    };

    function saveState() {
        localStorage.setItem(STATE_KEY, JSON.stringify(gameState));
        updateConsole();
    }

    function loadState() {
        const saved = localStorage.getItem(STATE_KEY);
        if(saved) {
            try { gameState = JSON.parse(saved); } catch(e) { console.error(e); }
        }
        applyTheme(gameState.theme || 'light');
        updateConsole();
        updatePhaseDisplay();
        updateStratBar();
    }

    function resetGame() {
        if(confirm("Reset Game? This clears all wounds, CP, and VP.")) {
            const currentTheme = gameState.theme;
            gameState = { turn: 0, cp: 0, vp: 0, phaseIdx: -1, activeId: 'rules', wounds: {}, theme: currentTheme };
            saveState();
            loadView('rules');
            updatePhaseDisplay();
            updateStratBar();
        }
    }

    function toggleTheme() {
        gameState.theme = gameState.theme === 'light' ? 'dark' : 'light';
        applyTheme(gameState.theme);
        saveState();
    }

    function applyTheme(theme) {
        const btn = document.getElementById('theme-toggle');
        if(theme === 'dark') {
            document.body.classList.add('dark-mode');
            btn.innerText = '‚òÄ';
        } else {
            document.body.classList.remove('dark-mode');
            btn.innerText = '‚óê';
        }
    }

    // --- 4. RENDER LOGIC ---
    
    // Side Bar
    const listEl = document.getElementById('unit-list');
    let lastGroup = '';
    TASK_FORCES.forEach(tf => {
        if(tf.group !== lastGroup) {
            const grp = document.createElement('div');
            grp.className = 'group-label';
            grp.textContent = tf.group;
            listEl.appendChild(grp);
            lastGroup = tf.group;
        }
        const btn = document.createElement('button');
        btn.id = `btn_${tf.id}`;
        btn.className = `unit-btn ${tf.type === 'combo' ? 'combo-btn' : ''} ${tf.id === 'rules' ? 'rules-btn' : ''}`;
        btn.textContent = tf.name;
        btn.onclick = () => loadView(tf.id);
        listEl.appendChild(btn);
    });

    function loadView(id) {
        gameState.activeId = id;
        saveState();
        
        document.querySelectorAll('.unit-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`btn_${id}`).classList.add('active');

        const data = TASK_FORCES.find(t => t.id === id);
        const container = document.getElementById('content-scroll');
        
        if(data.type === 'rules') {
            container.innerHTML = data.content;
            return;
        }

        let html = '';
        if(data.tactics) {
            html += `<div class="card tactics-card"><h3>‚ö° TACTIC: ${data.tactics.title}</h3><div class="tactics-detail">${data.tactics.desc}</div></div>`;
        }

        const unitList = data.type === 'combo' ? data.units : [{ profile: data.profile, count: data.count, label: 'Unit' }];
        html += `<div class="split-view">`;
        
        unitList.forEach((u, idx) => {
            const prof = PROFILES[u.profile];
            const uid = `${id}_${idx}`; 
            
            html += `<div class="split-col"><div class="card" id="card_${uid}">`;
            html += `<div class="unit-header">
                <div class="unit-title">${prof.name}</div>
                <div class="unit-role">${u.label}</div>
            </div>`;

            html += `<div class="stats-row">
                <div class="stat-box"><span class="stat-label">M</span><div class="stat-val">${prof.stats.M}</div></div>
                <div class="stat-box"><span class="stat-label">T</span><div class="stat-val">${prof.stats.T}</div></div>
                <div class="stat-box"><span class="stat-label">Sv</span><div class="stat-val">${prof.stats.Sv}</div></div>
                <div class="stat-box"><span class="stat-label">W</span><div class="stat-val">${prof.stats.W}</div></div>
                <div class="stat-box"><span class="stat-label">Ld</span><div class="stat-val">${prof.stats.Ld}</div></div>
                <div class="stat-box"><span class="stat-label">OC</span><div class="stat-val">${prof.stats.OC}</div></div>
                <div class="stat-box invuln-box"><span class="stat-label">INV</span><div class="stat-val">${prof.stats.invuln}</div></div>
            </div>`;

            html += `<div>`;
            const maxW = parseInt(prof.stats.W);
            for(let i=0; i<u.count; i++) {
                const wKey = `${uid}_${i}`;
                const curW = (gameState.wounds[wKey] !== undefined) ? gameState.wounds[wKey] : maxW;
                
                html += `<div class="wound-control">
                    <span style="font-size:0.8rem; font-weight:600; color:var(--text-sub);">Model ${i+1}</span>
                    <div style="display:flex; gap:8px; align-items:center;">
                        <div class="wound-btn" onclick="modW('${wKey}', -1, ${maxW}, '${uid}', ${u.count})">-</div>
                        <div class="wound-val" id="val_${wKey}" style="color:${curW===0?'var(--kw-neg)':'inherit'}">${curW}</div>
                        <div class="wound-btn" onclick="modW('${wKey}', 1, ${maxW}, '${uid}', ${u.count})">+</div>
                    </div>
                </div>`;
            }
            
            // Visual Alerts Placeholder
            html += `<div class="status-alert deadly-demise" id="dd_${uid}">‚ö†Ô∏è DEADLY DEMISE CHECK</div>`;
            html += `<div class="status-alert battleshock" id="bs_${uid}">‚ö†Ô∏è BATTLE-SHOCK TEST<br>(Below Half Strength)</div>`;
            
            html += `</div>`;

            html += `<div style="margin-top:15px;">`;
            prof.wargear.forEach(w => {
                html += `<div class="weapon-row">
                    <div class="weapon-header"><div class="weapon-name">${w.name}</div></div>
                    <table class="profile-table">
                        <thead><tr><th>RNG</th><th>A</th><th>HIT</th><th>S</th><th>AP</th><th>D</th></tr></thead>
                        <tbody><tr><td>${w.stats.range}</td><td>${w.stats.a}</td><td>${w.stats.bs||w.stats.ws}</td><td>${w.stats.s}</td><td>${w.stats.ap}</td><td>${w.stats.d}</td></tr></tbody>
                    </table>
                    <div style="font-size:0.7rem; margin-top:2px;">${formatKw(w.kw)}</div>
                </div>`;
            });
            
            prof.abilities.forEach(a => {
                const pId = (gameState.phaseIdx >= 0) ? PHASES[gameState.phaseIdx].id : '';
                const active = a.phases.includes(pId) || a.phases.includes('any');
                html += `<div class="ability ${active?'active-phase':''} ${a.name.includes('ENHANCEMENT')?'enhancement':''}">
                    <div class="ability-name">${a.name}</div><div class="ability-desc">${a.desc}</div>
                </div>`;
            });
            html += `</div></div></div>`;
        });
        html += `</div>`;
        container.innerHTML = html;

        // Post-render status check
        const unitList = data.type === 'combo' ? data.units : [{ profile: data.profile, count: data.count }];
        unitList.forEach((u, idx) => {
            checkUnitStatus(`${id}_${idx}`, u.count, parseInt(PROFILES[u.profile].stats.W));
        });
    }

    function updateStratBar() {
        const bar = document.getElementById('strat-bar');
        if(gameState.phaseIdx === -1) {
            bar.innerHTML = '<span style="color:rgba(255,255,255,0.5); font-size:0.8rem;">Awaiting Deployment...</span>';
            return;
        }

        const pId = PHASES[gameState.phaseIdx].id;
        let key = pId; 
        const strats = STRATAGEMS[key] || [];

        if(strats.length === 0) {
            bar.innerHTML = '<span style="color:rgba(255,255,255,0.5); font-size:0.8rem;">NO STRATAGEMS AVAILABLE</span>';
            return;
        }

        let html = '';
        strats.forEach((s, index) => {
            // Using index ID to prevent string escape errors
            html += `<div class="strat-pill ${s.type}" onclick="openStrat('${key}', ${index})">${s.name}</div>`;
        });
        bar.innerHTML = html;
    }
    
    function openStrat(phaseKey, index) {
        const s = STRATAGEMS[phaseKey][index];
        // Simple alert using template literal
        alert(`${s.name}\n\n${s.desc.replace(/<br>/g, "\n").replace(/<strong>/g, "").replace(/<\/strong>/g, "")}`);
    }

    // --- 5. GAME ENGINE LOGIC ---

    function modW(key, diff, max, uid, count) {
        if(gameState.wounds[key] === undefined) gameState.wounds[key] = max;
        
        let v = gameState.wounds[key] + diff;
        if(v < 0) v = 0;
        if(v > max) v = max;
        
        gameState.wounds[key] = v;
        saveState();
        
        const el = document.getElementById(`val_${key}`);
        if(el) {
            el.innerText = v;
            el.style.color = (v === 0) ? 'var(--kw-neg)' : 'inherit';
        }

        const baseUid = key.substring(0, key.lastIndexOf('_'));
        if(v === 0) {
            const ddEl = document.getElementById(`dd_${baseUid}`);
            if(ddEl) ddEl.style.display = 'block';
        }

        checkUnitStatus(uid, count, max);
    }

    function checkUnitStatus(uid, startCount, maxW) {
        let deadModels = 0;
        for(let i=0; i<startCount; i++) {
            const k = `${uid}_${i}`;
            // If undefined, it's alive (max health)
            const w = (gameState.wounds[k] !== undefined) ? gameState.wounds[k] : maxW;
            if(w === 0) deadModels++;
        }
        
        const currentModels = startCount - deadModels;
        const halfStrengthThreshold = startCount / 2;
        
        const bsEl = document.getElementById(`bs_${uid}`);
        const cardEl = document.getElementById(`card_${uid}`);
        const sidebarBtn = document.getElementById(`btn_${uid.split('_')[0]}_${uid.split('_')[1]}`); // Approximation

        if(bsEl && cardEl) {
            if(currentModels < halfStrengthThreshold) {
                bsEl.style.display = 'block';
                cardEl.classList.add('battleshock-active');
            } else {
                bsEl.style.display = 'none';
                cardEl.classList.remove('battleshock-active');
            }
        }
    }

    function modRes(type, diff) {
        if(type === 'cp') gameState.cp += diff;
        if(type === 'vp') gameState.vp += diff;
        if(gameState.cp < 0) gameState.cp = 0;
        if(gameState.vp < 0) gameState.vp = 0;
        saveState();
    }

    function updateConsole() {
        document.getElementById('cp-val').innerText = gameState.cp;
        document.getElementById('vp-val').innerText = gameState.vp;
    }

    function updatePhaseDisplay() {
        const btn = document.getElementById('next-phase-btn');
        const turnDisplay = document.getElementById('turn-display');
        const phaseName = document.getElementById('current-phase-name');
        const badge = document.getElementById('contagion-badge');

        if(gameState.phaseIdx === -1) {
            turnDisplay.innerText = "PRE-GAME";
            phaseName.innerText = "DEPLOYMENT";
            btn.innerText = "START GAME";
            badge.style.display = 'none';
        } else {
            const p = PHASES[gameState.phaseIdx];
            turnDisplay.innerText = `TURN ${gameState.turn}`;
            phaseName.innerText = p.label;
            btn.innerText = "NEXT PHASE";
            
            // Contagion Logic
            let range = 9;
            if(gameState.turn === 1) range = 3;
            if(gameState.turn === 2) range = 6;
            
            badge.style.display = 'inline-block';
            badge.innerText = `${range}" AURA`;
        }
    }

    document.getElementById('next-phase-btn').onclick = () => {
        requestWakeLock();

        if(gameState.phaseIdx === -1) {
            gameState.phaseIdx = 0;
            gameState.turn = 1;
            gameState.cp++; 
            alert("BATTLE STARTED: +1 CP (My Command)");
        } else {
            gameState.phaseIdx = (gameState.phaseIdx + 1) % PHASES.length;
            const p = PHASES[gameState.phaseIdx];

            if(gameState.phaseIdx === 0) gameState.turn++;

            if(p.cp) {
                gameState.cp++;
                const btn = document.getElementById('cp-val');
                btn.style.color = '#2ecc71';
                setTimeout(() => btn.style.color = '', 500);
            }
        }
        
        saveState();
        updatePhaseDisplay();
        updateStratBar();
        loadView(gameState.activeId); 
    };

    function formatKw(str) {
        if(!str) return '';
        return str.split(', ').map(k => {
            if(k.includes('LETHAL') || k.includes('SUSTAINED')) return `<span class="k-lethal">${k}</span>`;
            if(k.includes('ANTI') || k.includes('DEV')) return `<span class="k-anti">${k}</span>`;
            if(k.includes('BLAST') || k.includes('TORRENT') || k.includes('INDIRECT')) return `<span class="k-blast">${k}</span>`;
            return k;
        }).join(', ');
    }

    async function requestWakeLock() {
        try {
            if ('wakeLock' in navigator) {
                await navigator.wakeLock.request('screen');
            }
        } catch (err) { console.log('Wake Lock Error', err); }
    }

    loadState();
    if(gameState.activeId) loadView(gameState.activeId);

</script>
</body>
</html>
