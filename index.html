<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Death Lord's Chosen - Army Booklet</title>
    <style>
        :root {
            --bg-color: #fdf6e3; --surface-color: #f5efdb; --text-color: #4c463a;
            --header-color: #073642; --accent-color: #268bd2; --border-color: #dcd7c8;
            --highlight-color: #268bd2; --highlight-text: #fff;
            --stat-range-color: #cb4b16; --stat-attacks-color: #b58900; --stat-skill-color: #2aa198;
            --stat-strength-color: #dc322f; --stat-ap-color: #6c71c4; --stat-damage-color: #d33682;
            --keyword-positive-color: #859900; --keyword-negative-color: #dc322f;
            --keyword-core-color: #6c71c4; --keyword-special-color: #073642;
            --phase-highlight-color: #b58900; --aura-highlight-color: #268bd2;
            --deadly-demise-color: #dc322f;
        }

        html, body {
            height: 100%; margin: 0; overflow: hidden; background-color: var(--bg-color);
            color: var(--text-color); font-family: Verdana, Geneva, sans-serif; font-size: 16px;
            line-height: 1.6; letter-spacing: 0.5px; word-spacing: 1.5px;
        }

        #phase-tracker {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 25px; background-color: var(--header-color); color: var(--bg-color);
            flex-shrink: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        #current-phase-name { margin: 0; font-size: 1.5em; }
        #next-phase-btn {
            background-color: var(--accent-color); color: #fff; border: none;
            padding: 10px 20px; border-radius: 5px; font-weight: bold;
            font-size: 1em; cursor: pointer; transition: background-color 0.2s;
        }
        #next-phase-btn:hover { background-color: #55a8e2; }

        .app-body { display: flex; height: calc(100vh - 70px); }
        #unit-list {
            width: 300px; flex-shrink: 0; background-color: var(--surface-color); padding: 15px;
            border-right: 2px solid var(--border-color); display: flex; flex-direction: column; overflow-y: auto;
        }
        #unit-list h2 { margin-top: 0; color: var(--header-color); text-align: center; font-size: 1.5em; padding-bottom: 10px; border-bottom: 2px solid var(--border-color); }
        .unit-selector {
            display: block; width: 100%; padding: 12px 15px; margin-bottom: 8px; background-color: var(--bg-color);
            border: 1px solid var(--border-color); color: var(--text-color); text-align: left; cursor: pointer;
            border-radius: 4px; font-size: 1em; transition: all 0.2s ease-in-out;
        }
        .unit-selector:hover { border-color: var(--accent-color); box-shadow: 0 0 5px rgba(0,0,0,0.1); }
        .unit-selector.active { background-color: var(--highlight-color); border-color: var(--header-color); color: var(--highlight-text); font-weight: bold; }
        .unit-selector.rules-btn { border-left: 5px solid var(--keyword-negative-color); font-weight: bold; }

        #unit-details-wrapper { flex-grow: 1; display: flex; flex-direction: column; padding: 0 25px; overflow: hidden; }
        
        #unit-details-header {
            display: flex; justify-content: center; align-items: center; gap: 20px;
            flex-shrink: 0; text-align: center; font-size: 2em; font-weight: bold;
            color: var(--header-color); padding: 15px 0;
        }
        #unit-count-selector { font-size: 0.6em; padding: 5px; border-radius: 4px; border: 1px solid var(--border-color); }

        #unit-details { flex-grow: 1; display: flex; gap: 25px; padding-bottom: 15px; overflow: hidden; }
        .details-column { flex: 1; overflow-y: auto; padding-right: 10px; }
        .info-card { background-color: var(--surface-color); border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        
        .phase-highlight { border-color: var(--phase-highlight-color); box-shadow: 0 0 12px var(--phase-highlight-color); }
        .aura-highlight { border-left-color: var(--aura-highlight-color); border-left-width: 5px; }
        .enhancement-highlight { border-color: #d33682; box-shadow: 0 0 5px #d33682; }
        
        .section-title { font-size: 1.3em; color: var(--accent-color); font-weight: bold; border-bottom: 1px solid var(--border-color); padding-bottom: 8px; margin-top: 0; margin-bottom: 15px; }
        .stats-table { width: 100%; border-collapse: collapse; text-align: center; font-size: 1em; }
        .invuln-save { text-align: center; border-left: 1px solid var(--border-color); padding-left: 15px; margin-left: 15px; }
        .invuln-save strong { font-size: 1.5em; color: var(--keyword-core-color); }
        .invuln-save div { font-size: 0.7em; color: var(--text-muted); margin-top: 5px; }
        .stats-table th, .stats-table td { padding: 8px; }
        .stats-table th { color: var(--accent-color); font-weight: bold; }
        .stats-table td { font-weight: bold; font-size: 1.1em; }
        
        .wound-tracker-instance { display: flex; align-items: center; justify-content: space-between; padding: 8px; margin-bottom: 5px; border-radius: 5px; }
        .wound-tracker-label { font-weight: bold; font-size: 0.9em; }
        .wound-display { font-size: 1.5em; font-weight: bold; margin: 0 10px; color: var(--header-color); }
        .wound-btn {
            font-size: 1.5em; width: 35px; height: 35px; line-height: 35px; text-align: center;
            border-radius: 50%; border: 1px solid var(--border-color); background-color: var(--bg-color);
            cursor: pointer; color: var(--text-color);
        }
        .wound-btn:hover { background-color: var(--border-color); }

        .core-ability-list { display: flex; flex-wrap: wrap; gap: 8px; }
        .core-ability-pill { background: var(--bg-color); border: 1px solid var(--border-color); padding: 3px 8px; border-radius: 12px; font-size: 0.85em; transition: all 0.3s; }
        
        .deadly-demise-triggered { color: var(--deadly-demise-color) !important; font-weight: bold; border-color: var(--deadly-demise-color); }

        .item { margin-bottom: 15px; }
        .item.collapsible { cursor: pointer; }
        .item.collapsible strong::after { content: ' ▼'; font-size: 0.8em; color: var(--accent-color); }
        .item.collapsible.expanded strong::after { content: ' ▲'; }
        
        .item strong { font-size: 1.1em; color: var(--header-color); display: block; margin-bottom: 4px; }
        .item .ability-description { display: none; margin-top: 8px; padding-top: 8px; border-top: 1px dashed var(--border-color); }
        .item.expanded .ability-description { display: block; }
        .item p { margin: 0; line-height: 1.6; font-size: 0.95em;}
        .item ul { padding-left: 20px; margin: 5px 0; }
        
        .sub-item { margin-top: 10px; border-left: 2px solid var(--border-color); padding-left: 10px; }
        
        .weapon-profile { margin-top: 10px; margin-bottom: 10px; }
        .weapon-profile-name { font-style: italic; font-size: 1.1em; margin-bottom: 5px; font-weight: bold; color: var(--text-color); }
        .weapon-stats-table { width: 100%; border-collapse: collapse; text-align: center; background-color: var(--bg-color); border: 1px solid var(--border-color); }
        .weapon-stats-table th { font-size: 0.8em; padding: 4px; color: var(--accent-color); }
        .weapon-stats-table td { font-size: 0.9em; font-weight: bold; padding: 6px; }
        .weapon-abilities { font-size: 0.85em; margin-top: 5px; padding: 4px; }
        
        .keywords { text-align: center; font-size: 0.85em; } .keywords-faction { font-weight: bold; color: var(--accent-color); }
        .kw-range, .kw-attacks, .kw-skill, .kw-strength, .kw-ap, .kw-damage { font-weight: bold; }
        .kw-pos, .kw-neg, .kw-core, .kw-spec { font-weight: bold; }
        .kw-range { color: var(--stat-range-color); } .kw-attacks { color: var(--stat-attacks-color); } .kw-skill { color: var(--stat-skill-color); } .kw-strength { color: var(--stat-strength-color); } .kw-ap { color: var(--stat-ap-color); } .kw-damage { color: var(--stat-damage-color); }
        .kw-pos { color: var(--keyword-positive-color); } .kw-neg { color: var(--keyword-negative-color); } .kw-core { color: var(--keyword-core-color); } .kw-spec { color: var(--keyword-special-color); }
    </style>
</head>
<body>

<div id="phase-tracker">
    <h2 id="current-phase-name">Start of Game</h2>
    <button id="next-phase-btn">Start Turn 1</button>
</div>

<div class="app-body">
    <aside id="unit-list">
        <h2>Death Lord's Chosen</h2>
    </aside>
    <div id="unit-details-wrapper">
        <div id="unit-details-header">
            <span id="unit-name-display">Select a Unit</span>
            <div id="unit-count-wrapper" style="display: none;">
                <label for="unit-count-selector" style="font-size: 0.5em; font-weight: normal;">Model Count:</label>
                <select id="unit-count-selector" size="5"></select>
            </div>
        </div>
        <div id="unit-details"></div>
    </div>
</div>

<script>
    // --- DEATH LORD'S CHOSEN DATA ---
    const codexData = [
        {
            id: 'rules', name: '☠️ ARMY RULES',
            stats: null, wargear: [],
            abilities: {
                core: [],
                faction: [
                    { name: 'SKULLSQUIRM BLIGHT (Army Rule)', desc: 'At start of Battle Round: Select 1 enemy unit within 12" of a Nurgle Character. They are <strong>AFFLICTED</strong>.<br><strong>Effect:</strong> -1 Toughness (cannot be ignored).<br>This triggers "Afflicted" bonuses on your units.', phases: ['command_phase'] },
                    { name: 'CHOSEN OF THE PLAGUE GOD (Detachment)', desc: 'Whenever a CHARACTER destroys an enemy model, gain 1 Contagion Point (CPt). Spend CPt on detachment stratagems.', phases: ['any'] }
                ],
                unit: []
            },
            keywords: { main: [], faction: [] }
        },
        { 
            id: 'lord_of_contagion', name: 'Lord of Contagion (150pts)', 
            stats: { M: '5"', T: '6', Sv: '2+', W: '6', Ld: '6+', OC: '1', invuln: '4+' }, 
            wargear: [ 
                { name: 'Manreaper', type: 'Melee', profiles: [ 
                    { name: 'Strike', range: 'Melee', a: '5', ws: '2+', s: '9', ap: '-3', d: '3', abilities: '[<span class="kw-pos">LETHAL HITS</span>]' }, 
                    { name: 'Sweep', range: 'Melee', a: '10', ws: '2+', s: '6', ap: '-1', d: '1', abilities: '[<span class="kw-pos">LETHAL HITS</span>]' } 
                ]} 
            ], 
            abilities: { 
                core: [{ name: 'Deep Strike', phases: ['my_movement'] }, { name: 'Leader', phases: ['pregame'] }], 
                faction: [{ name: "Nurgle's Gift (Aura)", desc: 'Worsen enemy Leadership and OC by 1 within Contagion Range.', phases: ['aura'] }], 
                unit: [ 
                    { name: 'Vector of Disease', desc: 'While leading a unit, their melee weapons gain <strong>[SUSTAINED HITS 1]</strong> and <strong>[LANCE]</strong>.', phases: ['fight'] },
                    { name: 'Unholy Resilience', desc: 'First time this model is destroyed: Roll D6 at end of phase. On 2+, return with 3 wounds.', phases: ['any'] },
                    { name: 'Enhancement: Warprot Talisman', desc: '+1 to Feel No Pain rolls the first time bearer is reduced to 0 wounds (lasts phase). Aura range +3".', phases: ['pregame', 'any'] }
                ], 
                leader: 'Attached to: Blightlord Terminators, Deathshroud Terminators.' 
            }, 
            keywords: { main: ['INFANTRY', 'CHARACTER', 'CHAOS', 'NURGLE', 'TERMINATOR', 'LORD OF CONTAGION'], faction: ['DEATH GUARD'] } 
        },
        { 
            id: 'lord_of_virulence', name: 'Lord of Virulence (120pts)', 
            stats: { M: '5"', T: '6', Sv: '2+', W: '6', Ld: '6+', OC: '1', invuln: '4+' }, 
            wargear: [ 
                { name: 'Twin plague spewer', type: 'Ranged', profiles: [{ range: '12"', a: 'D6', bs: 'N/A', s: '5', ap: '-1', d: '1', abilities: '[<span class="kw-neg">ANTI-INFANTRY 2+</span>, <span class="kw-spec">IGNORES COVER</span>, <span class="kw-spec">TORRENT</span>, <span class="kw-spec">TWIN-LINKED</span>]' } ]}, 
                { name: 'Power fist', type: 'Melee', profiles: [{ range: 'Melee', a: '5', ws: '2+', s: '8', ap: '-2', d: '2', abilities: '[<span class="kw-pos">LETHAL HITS</span>]' } ]} 
            ], 
            abilities: { 
                core: [{ name: 'Deep Strike', phases: ['my_movement'] }, { name: 'Leader', phases: ['pregame'] }], 
                faction: [{ name: "Nurgle's Gift (Aura)", desc: 'Worsen enemy Leadership and OC by 1 within Contagion Range.', phases: ['aura'] }], 
                unit: [ 
                    { name: 'Virulent Aura', desc: 'While leading a unit, re-roll <strong>Wound rolls</strong> for ranged attacks.', phases: ['my_shooting', 'opponent_shooting'] }, 
                    { name: 'Blight Bombardment', desc: 'Start of Shooting: Select visible enemy within 30". Blast weapons re-roll Hits vs target. Others re-roll Hit rolls of 1.', phases: ['my_shooting']},
                    { name: 'Enhancement: Helm of The Fly King', desc: 'Enemy units within 6" suffer -1 to Hit (ranged and melee). If leading a unit, applies to them too.', phases: ['aura', 'my_shooting', 'fight', 'opponent_shooting'] }
                ], 
                leader: 'Attached to: Blightlord Terminators, Deathshroud Terminators.' 
            }, 
            keywords: { main: ['INFANTRY', 'CHARACTER', 'CHAOS', 'NURGLE', 'TERMINATOR', 'LORD OF VIRULENCE'], faction: ['DEATH GUARD'] } 
        },
        { 
            id: 'typhus', name: 'Typhus (100pts)', 
            stats: { M: '5"', T: '6', Sv: '2+', W: '6', Ld: '6+', OC: '1', invuln: '4+' }, 
            wargear: [ 
                { name: 'Lakrimae', type: 'Melee', profiles: [ 
                    { name: 'Strike', range: 'Melee', a: '6', ws: '2+', s: '9', ap: '-2', d: '3', abilities: '[<span class="kw-pos">LETHAL HITS</span>]' }, 
                    { name: 'Sweep', range: 'Melee', a: '12', ws: '2+', s: '6', ap: '-1', d: '1', abilities: '[<span class="kw-pos">LETHAL HITS</span>]' } 
                ]} 
            ], 
            abilities: { 
                core: [{ name: 'Deep Strike', phases: ['my_movement'] }, { name: 'Leader', phases: ['pregame'] }], 
                faction: [{ name: "Nurgle's Gift (Aura)", desc: 'Worsen enemy Leadership and OC by 1 within Contagion Range.', phases: ['aura'] }], 
                unit: [ 
                    { name: 'Destroyer Hive', desc: 'While leading a unit, <strong>-1 to Hit</strong> for melee attacks targeting that unit.', phases: ['fight'] }, 
                    { name: 'Eater Plague (Psychic)', desc: 'Start of Shooting: Select visible enemy within 18". Roll D6.<br>1: You take D3 MW.<br>2-5: Enemy takes D6 MW.<br>6: Enemy takes D3+3 MW.', phases: ['my_shooting'] } 
                ], 
                leader: 'Attached to: Blightlord Terminators, Deathshroud Terminators, Poxwalkers.' 
            }, 
            keywords: { main: ['INFANTRY', 'CHARACTER', 'PSYKER', 'EPIC HERO', 'CHAOS', 'NURGLE', 'TERMINATOR', 'TYPHUS'], faction: ['DEATH GUARD'] } 
        },
        { 
            id: 'blightlord_terminators', name: 'Blightlord Terminators (185pts)', 
            stats: { M: '5"', T: '7', Sv: '2+', W: '3', Ld: '6+', OC: '1', invuln: '4+' }, 
            wargear: [ 
                { name: 'Combi-bolter', type: 'Ranged', profiles: [{ range: '24"', a: '2', bs: '3+', s: '4', ap: '0', d: '1', abilities: '[<span class="kw-pos">LETHAL HITS</span>, <span class="kw-spec">RAPID FIRE 2</span>]' }]}, 
                { name: 'Blight launcher', type: 'Ranged', profiles: [{ range: '24"', a: 'D3', bs: '3+', s: '6', ap: '-1', d: '2', abilities: '[<span class="kw-pos">LETHAL HITS</span>]' }]}, 
                { name: 'Reaper autocannon', type: 'Ranged', profiles: [{ range: '36"', a: '4', bs: '3+', s: '7', ap: '-1', d: '1', abilities: '[<span class="kw-pos">SUSTAINED HITS 1</span>]' }]}, 
                { name: 'Plague spewer', type: 'Ranged', profiles: [{ range: '12"', a: 'D6', bs: 'N/A', s: '5', ap: '-1', d: '1', abilities: '[<span class="kw-neg">ANTI-INFANTRY 2+</span>, <span class="kw-spec">IGNORES COVER</span>, <span class="kw-spec">TORRENT</span>]' }]}, 
                { name: 'Flail of corruption', type: 'Melee', profiles: [{ range: 'Melee', a: '6', ws: '3+', s: '5', ap: '-1', d: '2', abilities: '[<span class="kw-pos">LETHAL HITS</span>]' }]}, 
                { name: 'Bubotic blade', type: 'Melee', profiles: [{ range: 'Melee', a: '3', ws: '3+', s: '5', ap: '-2', d: '2', abilities: '[<span class="kw-pos">LETHAL HITS</span>]' }]} 
            ], 
            abilities: { 
                core: [{ name: 'Deep Strike', phases: ['my_movement'] }], 
                faction: [{ name: "Nurgle's Gift (Aura)", desc: 'Worsen enemy Leadership and OC by 1 within Contagion Range.', phases: ['aura'] }], 
                unit: [ { name: 'Blistering Fusillade', desc: 'If 5+ models OR Led by Character: <strong>+1 Strength and +1 AP</strong> against <strong>AFFLICTED</strong> units.', phases: ['my_shooting'] } ] 
            }, 
            keywords: { main: ['INFANTRY', 'CHAOS', 'NURGLE', 'TERMINATOR', 'BLIGHTLORD TERMINATORS'], faction: ['DEATH GUARD']} 
        },
        { 
            id: 'deathshroud_terminators', name: 'Deathshroud Terminators', 
            stats: { M: '5"', T: '7', Sv: '2+', W: '4', Ld: '6+', OC: '1', invuln: '4+' }, 
            wargear: [ 
                { name: 'Plaguespurt gauntlet', type: 'Ranged', profiles: [ { range: '12"', a: 'D6', bs: 'N/A', s: '3', ap: '0', d: '1', abilities: '[<span class="kw-neg">ANTI-INFANTRY 4+</span>, <span class="kw-spec">IGNORES COVER</span>, <span class="kw-spec">PISTOL</span>, <span class="kw-spec">TORRENT</span>]' } ]}, 
                { name: 'Manreaper', type: 'Melee', profiles: [ { name: 'Strike', range: 'Melee', a: '4', ws: '2+', s: '8', ap: '-2', d: '2', abilities: '[<span class="kw-pos">LETHAL HITS</span>]' }, { name: 'Sweep', range: 'Melee', a: '8', ws: '3+', s: '4', ap: '-1', d: '1', abilities: '[<span class="kw-pos">LETHAL HITS</span>]' } ]} 
            ], 
            abilities: { 
                core: [{ name: 'Deep Strike', phases: ['my_movement'] }], 
                faction: [{ name: "Nurgle's Gift (Aura)", desc: 'Worsen enemy Leadership and OC by 1 within Contagion Range.', phases: ['aura'] }], 
                unit: [ 
                    { name: 'Silent Bodyguard', desc: 'Attached CHARACTER has <strong>Feel No Pain 4+</strong>.', phases: ['any'] }, 
                    { name: 'Death Approaches', desc: 'Deep Strike > 6" away from <strong>AFFLICTED</strong> enemy units (instead of 9").', phases: ['my_movement'] } 
                ], 
                wargear_abilities: [ { name: 'Icon of Despair (Aura)', desc: 'Enemy units within 6" get -1 Leadership.', phases: ['aura'] } ] 
            }, 
            keywords: { main: ['INFANTRY', 'CHARACTER', 'CHAOS', 'NURGLE', 'TERMINATOR', 'DEATHSHROUD TERMINATORS'], faction: ['DEATH GUARD'] } 
        },
        { 
            id: 'chaos_spawn', name: 'Chaos Spawn (80pts)', 
            stats: { M: '8"', T: '5', Sv: '4+', W: '4', Ld: '7+', OC: '1', invuln: '5+' }, 
            wargear: [ 
                { name: 'Hideous mutations', type: 'Melee', profiles: [ { range: 'Melee', a: 'D6+2', ws: '4+', s: '5', ap: '-1', d: '2', abilities: '' } ]} 
            ], 
            abilities: { 
                core: [{ name: 'Feel No Pain 5+', phases: ['any'] }, { name: 'Scouts 6"', phases: ['pregame'] }, { name: 'Deadly Demise 1', phases: ['any'] }], 
                faction: [{ name: "Nurgle's Gift (Aura)", desc: 'Worsen enemy Leadership and OC by 1 within Contagion Range.', phases: ['aura'] }], 
                unit: [ 
                    { name: 'Lethal Ichor', desc: 'Melee: After enemy finishes attacking, roll D6 per enemy unit (max 6D6). On 4+, enemy suffers 1 MW.', phases: ['fight'] }
                ]
            }, 
            keywords: { main: ['BEAST', 'CHAOS', 'NURGLE', 'CHAOS SPAWN'], faction: ['DEATH GUARD'] } 
        },
        { 
            id: 'foetid_bloat_drone', name: 'Foetid Bloat-drone (120pts)', 
            stats: { M: '10"', T: '9', Sv: '3+', W: '10', Ld: '6+', OC: '3', invuln: '5+' }, 
            wargear: [ 
                { name: 'Heavy blight launcher', type: 'Ranged', profiles: [ { range: '36"', a: 'D6+2', bs: '3+', s: '10', ap: '-2', d: '3', abilities: '[<span class="kw-spec">BLAST</span>, <span class="kw-pos">LETHAL HITS</span>]' } ]}, 
                { name: 'Plague probe', type: 'Melee', profiles: [ { range: 'Melee', a: '3', ws: '3+', s: '6', ap: '-1', d: '1', abilities: '[<span class="kw-pos">LETHAL HITS</span>]' } ]} 
            ], 
            abilities: { 
                core: [{ name: 'Deadly Demise D3', desc: 'On 5+, explodes (3" / D3 MW).', phases: ['any'] }], 
                faction: [{ name: "Nurgle's Gift (Aura)", desc: 'Worsen enemy Leadership and OC by 1 within Contagion Range.', phases: ['aura'] }], 
                unit: [ { name: 'Explosive Blight', desc: 'Shooting Phase: If model destroys a unit, roll D6 (+1 if Afflicted). On 5+, all enemies within 6" become <strong>AFFLICTED</strong>.', phases: ['my_shooting'] } ] 
            }, 
            keywords: { main: ['VEHICLE', 'FLY', 'CHAOS', 'NURGLE', 'DAEMON', 'FOETID BLOAT-DRONE'], faction: ['DEATH GUARD'] } 
        },
        { 
            id: 'plagueburst_crawler', name: 'Plagueburst Crawler (210pts)', 
            stats: { M: '10"', T: '10', Sv: '2+', W: '12', Ld: '6+', OC: '3', invuln: '5+' }, 
            wargear: [ 
                { name: 'Entropy cannon', type: 'Ranged', profiles: [ { range: '24"', a: '1', bs: '3+', s: '10', ap: '-3', d: 'D6+1', abilities: '[<span class="kw-pos">LETHAL HITS</span>]' } ]}, 
                { name: 'Heavy slugger', type: 'Ranged', profiles: [ { range: '36"', a: '4', bs: '3+', s: '5', ap: '-1', d: '1', abilities: '[<span class="kw-pos">LETHAL HITS</span>]' } ]}, 
                { name: 'Plagueburst mortar', type: 'Ranged', profiles: [ { range: '48"', a: 'D6+3', bs: '3+', s: '8', ap: '-1', d: '2', abilities: '[<span class="kw-spec">BLAST</span>, <span class="kw-spec">INDIRECT FIRE</span>, <span class="kw-pos">LETHAL HITS</span>]' } ]}, 
                { name: 'Armoured tracks', type: 'Melee', profiles: [ { range: 'Melee', a: '3', ws: '4+', s: '6', ap: '0', d: '1', abilities: '' } ]} 
            ], 
            abilities: { 
                core: [{ name: 'Deadly Demise D3', desc: 'On 5+, explodes (3" / D3 MW).', phases: ['any'] }], 
                faction: [{ name: "Nurgle's Gift (Aura)", desc: 'Worsen enemy Leadership and OC by 1 within Contagion Range.', phases: ['aura'] }], 
                unit: [ { name: 'Spore-laced Shock Waves', desc: 'Mortar attack: Roll D6 for target and units within 3". +1 if <strong>AFFLICTED</strong>. On 6+, unit takes D3 MW after shooting resolves.', phases: ['my_shooting'] } ], 
                damaged: '1-4 wounds remaining: -1 to Hit.' 
            }, 
            keywords: { main: ['VEHICLE', 'CHAOS', 'NURGLE', 'DAEMON', 'PLAGUEBURST CRAWLER'], faction: ['DEATH GUARD'] } 
        },
        { 
            id: 'poxwalkers', name: 'Poxwalkers (65pts)', 
            stats: { M: '4"', T: '4', Sv: '7+', W: '1', Ld: '8+', OC: '1', invuln: '6+' }, 
            wargear: [ 
                { name: 'Improvised weapon', type: 'Melee', profiles: [ { range: 'Melee', a: '2', ws: '5+', s: '3', ap: '0', d: '1', abilities: '[<span class="kw-pos">LETHAL HITS</span>]' } ]} 
            ], 
            abilities: { 
                core: [{ name: 'Feel No Pain 5+', phases: ['any'] }, { name: 'Infiltrators', phases: ['pregame'] }], 
                faction: [{ name: "Nurgle's Gift (Aura)", desc: 'Worsen enemy Leadership and OC by 1 within Contagion Range.', phases: ['aura'] }], 
                unit: [ 
                    { name: 'Curse of the Walking Pox', desc: 'Fight Phase: Each time you destroy an enemy INFANTRY model, return 1 destroyed Poxwalker to unit. (Includes Typhus kills).', phases: ['fight'] }
                ]
            }, 
            keywords: { main: ['INFANTRY', 'CHAOS', 'NURGLE', 'POXWALKERS'], faction: ['DEATH GUARD'] } 
        }
    ];

    // --- JAVASCRIPT LOGIC ---
    const gamePhases = [
        { id: 'command_phase', label: "My Turn - Command" },
        { id: 'my_movement', label: "My Turn - Movement" }, { id: 'my_shooting', label: "My Turn - Shooting" },
        { id: 'my_charge', label: "My Turn - Charge" }, { id: 'fight', label: "My Turn - Fight" },
        { id: 'opponent_movement', label: "Opponent's - Movement" }, { id: 'opponent_shooting', label: "Opponent's - Shooting" },
        { id: 'opponent_charge', label: "Opponent's - Charge" }, { id: 'fight', label: "Opponent's - Fight" },
    ];
    let currentPhaseIndex = -1, selectedUnitId = null, woundTrackers = [];

    const unitListEl = document.getElementById('unit-list'),
        unitDetailsHeaderEl = document.getElementById('unit-details-header'), unitDetailsEl = document.getElementById('unit-details'),
        phaseNameEl = document.getElementById('current-phase-name'), nextPhaseBtn = document.getElementById('next-phase-btn'),
        unitNameDisplayEl = document.getElementById('unit-name-display'), unitCountWrapperEl = document.getElementById('unit-count-wrapper'),
        unitCountSelectorEl = document.getElementById('unit-count-selector');

    function updatePhase() {
        currentPhaseIndex = (currentPhaseIndex + 1) % gamePhases.length;
        phaseNameEl.textContent = gamePhases[currentPhaseIndex].label;
        nextPhaseBtn.textContent = "Next Phase";
        if (selectedUnitId) { displayUnitDetails(selectedUnitId, true); }
    }

    function getHighlightClass(ability) {
        if (!ability?.phases || currentPhaseIndex < 0) return '';
        const currentPhaseId = gamePhases[currentPhaseIndex].id;
        if (ability.phases.includes(currentPhaseId)) return 'phase-highlight';
        if (ability.phases.includes('aura')) return 'aura-highlight';
        if (ability.name.includes('Enhancement')) return 'enhancement-highlight'; 
        if (ability.phases.includes('any') && (ability.name.includes("Feel No Pain") && (currentPhaseId.includes("shooting") || currentPhaseId.includes("fight")))) {
            return 'phase-highlight';
        }
        return '';
    }
    
    function changeWounds(index, amount) {
        const idx = parseInt(index, 10);
        const tracker = woundTrackers[idx];
        if (!tracker) return;
        tracker.current = Math.max(0, Math.min(tracker.max, tracker.current + amount));
        const woundDisplay = document.getElementById(`wound-display-${idx}`);
        if (woundDisplay) { woundDisplay.textContent = tracker.current; }
        updateDeadlyDemiseHighlight();
    }
    
    function updateDeadlyDemiseHighlight() {
        const ddPill = document.getElementById('deadly-demise-pill');
        if (!ddPill) return;
        const hasDestroyedModels = woundTrackers.some(t => t.current === 0);
        const unit = codexData.find(u => u.id === selectedUnitId);
        const hasDeadlyDemise = unit && unit.abilities.core.some(a => a.name.includes('Deadly Demise'));
        if (hasDestroyedModels && hasDeadlyDemise) {
            ddPill.classList.add('deadly-demise-triggered');
        } else {
            ddPill.classList.remove('deadly-demise-triggered');
        }
    }
    
    function renderWoundTrackers() {
        const container = document.getElementById('multi-wound-tracker-container');
        if (!container) return;
        let html = '';
        woundTrackers.forEach((tracker, index) => {
            html += `
                <div class="wound-tracker-instance" id="wound-tracker-${index}">
                    <span class="wound-tracker-label">Model ${index + 1}</span>
                    <div>
                        <button class="wound-btn wound-minus-btn" data-index="${index}">-</button>
                        <span id="wound-display-${index}" class="wound-display">${tracker.current}</span> / ${tracker.max} W
                        <button class="wound-btn wound-plus-btn" data-index="${index}">+</button>
                    </div>
                </div>`;
        });
        container.innerHTML = html;
        document.querySelectorAll('.wound-minus-btn').forEach(btn => btn.addEventListener('click', (e) => changeWounds(e.target.dataset.index, -1)));
        document.querySelectorAll('.wound-plus-btn').forEach(btn => btn.addEventListener('click', (e) => changeWounds(e.target.dataset.index, 1)));
    }

    function updateUnitCount(count) {
        const unit = codexData.find(u => u.id === selectedUnitId);
        if (!unit || !unit.stats) return; // Rules have no stats
        const maxWounds = parseInt(unit.stats.W);
        woundTrackers = Array.from({ length: count }, () => ({ current: maxWounds, max: maxWounds }));
        renderWoundTrackers();
        updateDeadlyDemiseHighlight();
    }
    
    function displayUnitDetails(unitId, isPhaseUpdate = false) {
        if (!isPhaseUpdate) {
            selectedUnitId = unitId;
            unitCountWrapperEl.style.display = (unitId === 'rules') ? 'none' : 'block';
            unitCountSelectorEl.value = 1;
        }
        const unit = codexData.find(u => u.id === unitId);
        if (!unit) return;

        if (!isPhaseUpdate && unitId !== 'rules') {
            let defaultCount = 1;
            if (unit.id === 'deathshroud_terminators') defaultCount = 3;
            if (unit.id === 'poxwalkers') defaultCount = 10;
            if (unit.id === 'chaos_spawn') defaultCount = 2;
            if (unit.id === 'blightlord_terminators') defaultCount = 5;
            updateUnitCount(defaultCount);
            unitCountSelectorEl.value = defaultCount;
        }

        unitNameDisplayEl.innerHTML = unit.name;
        
        if (unitId === 'rules') {
             let html = `<div class="details-column" style="max-width: 800px; margin: 0 auto;"><div class="info-card"><h3 class="section-title">Army Rules</h3>`;
             unit.abilities.faction.forEach(a => {
                 html += `<div class="item collapsible expanded ${getHighlightClass(a)}"><strong class="ability-name">${a.name}</strong><div class="ability-description" style="display:block"><p>${a.desc}</p></div></div>`;
             });
             html += `</div></div>`;
             unitDetailsEl.innerHTML = html;
             return;
        }

        let col1HTML = `<div class="details-column"><div class="info-card"><div style="display: flex; align-items: center;"><table class="stats-table"><thead><tr><th>M</th><th>T</th><th>Sv</th><th>W</th><th>Ld</th><th>OC</th></tr></thead><tbody><tr><td>${unit.stats.M}</td><td>${unit.stats.T}</td><td>${unit.stats.Sv}</td><td>${unit.stats.W}</td><td>${unit.stats.Ld}</td><td>${unit.stats.OC}</td></tr></tbody></table>${unit.stats.invuln ? `<div class="invuln-save"><strong>${unit.stats.invuln}</strong><div>INVULN</div></div>` : ''}</div></div><div class="info-card"><h3 class="section-title">Wound Tracker</h3><div id="multi-wound-tracker-container"></div></div>`;
        const rangedWeapons = unit.wargear.filter(w => w.type === 'Ranged');
        if (rangedWeapons.length > 0) {
            col1HTML += `<div class="info-card"><h3 class="section-title">Ranged Weapons</h3>`;
            rangedWeapons.forEach(weapon => {
                col1HTML += `<div class="item"><strong class="wargear-name">${weapon.name}</strong>`;
                weapon.profiles.forEach(p => {
                    col1HTML += `<div class="weapon-profile">
                        ${p.name ? `<div class="weapon-profile-name">${p.name}</div>` : ''}
                        <table class="weapon-stats-table">
                            <thead><tr><th>Range</th><th>A</th><th>${p.bs ? 'BS' : 'WS'}</th><th>S</th><th>AP</th><th>D</th></tr></thead>
                            <tbody><tr>
                                <td><span class="kw-range">${p.range}</span></td><td><span class="kw-attacks">${p.a}</span></td><td><span class="kw-skill">${p.bs || p.ws}</span></td>
                                <td><span class="kw-strength">${p.s}</span></td><td><span class="kw-ap">${p.ap}</span></td><td><span class="kw-damage">${p.d}</span></td>
                            </tr></tbody>
                        </table>
                        ${p.abilities ? `<div class="weapon-abilities">${p.abilities}</div>` : ''}
                    </div>`;
                });
                col1HTML += `</div>`;
            });
            col1HTML += `</div>`;
        }
        const meleeWeapons = unit.wargear.filter(w => w.type === 'Melee');
        if (meleeWeapons.length > 0) {
            col1HTML += `<div class="info-card"><h3 class="section-title">Melee Weapons</h3>`;
            meleeWeapons.forEach(weapon => {
                col1HTML += `<div class="item"><strong class="wargear-name">${weapon.name}</strong>`;
                weapon.profiles.forEach(p => {
                    col1HTML += `<div class="weapon-profile">
                        ${p.name ? `<div class="weapon-profile-name">${p.name}</div>` : ''}
                        <table class="weapon-stats-table">
                            <thead><tr><th>Range</th><th>A</th><th>${p.bs ? 'BS' : 'WS'}</th><th>S</th><th>AP</th><th>D</th></tr></thead>
                            <tbody><tr>
                                <td><span class="kw-range">${p.range}</span></td><td><span class="kw-attacks">${p.a}</span></td><td><span class="kw-skill">${p.bs || p.ws}</span></td>
                                <td><span class="kw-strength">${p.s}</span></td><td><span class="kw-ap">${p.ap}</span></td><td><span class="kw-damage">${p.d}</span></td>
                            </tr></tbody>
                        </table>
                        ${p.abilities ? `<div class="weapon-abilities">${p.abilities}</div>` : ''}
                    </div>`;
                });
                col1HTML += `</div>`;
            });
            col1HTML += `</div>`;
        }
        col1HTML += `</div>`;

        let col2HTML = `<div class="details-column"><div class="info-card">`;
        if (unit.abilities.wargear_abilities) {
            col2HTML += `<h3 class="section-title">Wargear Abilities</h3>`;
             unit.abilities.wargear_abilities.forEach(a => { col2HTML += `<div class="item collapsible ${getHighlightClass(a)}"><strong class="wargear-name">${a.name}</strong><div class="ability-description"><p>${a.desc}</p></div></div>`; });
        }
        col2HTML += `<h3 class="section-title">Abilities</h3>`;
        if (unit.abilities.core) {
            const hasDestroyedModels = woundTrackers.some(t => t.current === 0);
            const corePills = unit.abilities.core.map(a => {
                const isDD = a.name.includes('Deadly Demise');
                const ddId = isDD ? 'id="deadly-demise-pill"' : '';
                const ddTriggeredClass = (isDD && hasDestroyedModels) ? 'deadly-demise-triggered' : '';
                return `<span ${ddId} class="core-ability-pill ${getHighlightClass(a)} ${ddTriggeredClass}">${a.name}</span>`;
            }).join('');
            col2HTML += `<div class="item"><strong class="ability-name">Core</strong><div class="core-ability-list">${corePills}</div></div>`;
        }
        if (unit.abilities.faction) {
            unit.abilities.faction.forEach(a => { col2HTML += `<div class="item collapsible ${getHighlightClass(a)}"><strong class="ability-name">${a.name}</strong><div class="ability-description"><p>${a.desc}</p></div></div>`; });
        }
        if (unit.abilities.unit) {
            unit.abilities.unit.forEach(a => {
                col2HTML += `<div class="item collapsible ${getHighlightClass(a)}"><strong class="ability-name">${a.name}</strong><div class="ability-description"><p>${a.desc}</p>`;
                if (a.sub_abilities) { a.sub_abilities.forEach(sub => { col2HTML += `<div class="sub-item item"><strong class="ability-name">${sub.name}</strong><p>${sub.desc}</p></div>`; }); }
                col2HTML += `</div></div>`;
            });
        }
        if (unit.abilities.leader) { col2HTML += `<div class="item"><strong class="ability-name">Leader</strong><p>${unit.abilities.leader}</p></div>`; }
        if (unit.abilities.damaged) { col2HTML += `<div class="item"><strong class="ability-name">Damaged</strong><p>${unit.abilities.damaged}</p></div>`; }
        col2HTML += `</div>`;
        col2HTML += `<div class="info-card keywords"><p>${unit.keywords.main.join(' • ')}</p><p><span class="keywords-faction">FACTION KEYWORDS:</span> ${unit.keywords.faction.join(', ')}</p></div>`;
        col2HTML += `</div>`;

        unitDetailsEl.innerHTML = col1HTML + col2HTML;
        
        renderWoundTrackers();

        if (!isPhaseUpdate) {
            document.querySelectorAll('.unit-selector').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.unitId === unitId) { btn.classList.add('active'); }
            });
        }
    }

    function populateUnitList() {
        unitListEl.innerHTML = '<h2>Death Lord\'s Chosen</h2>';
        // Rules button first
        const rulesBtn = document.createElement('button');
        rulesBtn.innerText = "☠️ ARMY RULES";
        rulesBtn.className = 'unit-selector rules-btn';
        rulesBtn.dataset.unitId = 'rules';
        rulesBtn.onclick = () => displayUnitDetails('rules');
        unitListEl.appendChild(rulesBtn);

        codexData.filter(u => u.id !== 'rules').sort((a, b) => a.name.localeCompare(b.name)).forEach(unit => {
            const button = document.createElement('button');
            button.innerText = unit.name; button.className = 'unit-selector';
            button.dataset.unitId = unit.id; button.onclick = () => displayUnitDetails(unit.id);
            unitListEl.appendChild(button);
        });
    }

    let selectorHTML = '';
    for (let i = 1; i <= 20; i++) { selectorHTML += `<option value="${i}">${i}</option>`; }
    unitCountSelectorEl.innerHTML = selectorHTML;

    nextPhaseBtn.addEventListener('click', updatePhase);
    unitCountSelectorEl.addEventListener('change', (e) => updateUnitCount(parseInt(e.target.value)));
    
    unitDetailsEl.addEventListener('click', function(e) {
        const targetItem = e.target.closest('.item.collapsible');
        if (targetItem) {
            targetItem.classList.toggle('expanded');
        }
    });

    populateUnitList();
    displayUnitDetails('rules'); // Show rules on load
</script>

</body>
</html>
