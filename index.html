<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Chosen: Command Bunker</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="The Chosen">
    <link rel="apple-touch-icon" href="https://img.icons8.com/color/48/biohazard.png">

    <style>
        :root {
            --bg-color: #eaedf0; --surface-color: #ffffff; --text-color: #1c1e21;
            --header-color: #2c3e50; --accent-color: #2980b9; --border-color: #cfd8dc;
            --highlight-color: #27ae60; --alert-color: #c0392b;
            --console-bg: #1a1a1a; --console-text: #f1f1f1;
            --stat-bg: #f1f2f6;
            --strat-dg: #27ae60; --strat-core: #7f8c8d;
        }

        html, body {
            height: 100%; margin: 0; overflow: hidden; background-color: var(--bg-color);
            color: var(--text-color); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            font-size: 14px; line-height: 1.4; -webkit-tap-highlight-color: transparent;
        }

        /* --- Layout --- */
        #app-container { display: flex; flex-direction: column; height: 100%; }

        /* --- Top Bar (Phase) --- */
        #phase-tracker {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 15px; background-color: var(--header-color); color: #fff;
            height: 50px; flex-shrink: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 10;
        }
        .phase-info { display: flex; flex-direction: column; }
        .turn-label { font-size: 0.65rem; opacity: 0.8; letter-spacing: 1px; text-transform: uppercase; }
        #current-phase-name { font-size: 1.1rem; font-weight: 800; text-transform: uppercase; }
        
        #next-phase-btn {
            background-color: var(--accent-color); color: #fff; border: none;
            padding: 6px 16px; border-radius: 20px; font-weight: 700; cursor: pointer;
            font-size: 0.85rem; transition: background 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        #next-phase-btn:active { transform: scale(0.95); }

        /* --- Body (Split View) --- */
        #main-body { display: flex; flex-grow: 1; overflow: hidden; position: relative; }
        
        /* Sidebar */
        #unit-list {
            width: 260px; flex-shrink: 0; background-color: #dfe4ea; 
            border-right: 1px solid var(--border-color); overflow-y: auto; padding: 10px;
            padding-bottom: 120px; /* Space for footer */
        }
        .group-label { font-size: 0.7rem; font-weight: 900; color: #7f8c8d; margin: 12px 0 4px 6px; text-transform: uppercase; letter-spacing: 0.5px; }
        .unit-btn {
            display: block; width: 100%; padding: 12px 12px; margin-bottom: 6px;
            background: #fff; border: 1px solid #b0b8be; border-radius: 8px;
            text-align: left; font-weight: 700; color: #2c3e50; cursor: pointer;
            font-size: 0.9rem; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .unit-btn.active { background-color: var(--header-color); color: #fff; border-color: var(--header-color); transform: translateX(4px); }
        .unit-btn.rules-btn { border-left: 5px solid var(--alert-color); }
        .unit-btn.combo-btn { border-left: 5px solid var(--highlight-color); }

        /* Content Area */
        #unit-details-wrapper { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; background: var(--bg-color); }
        #content-scroll { flex-grow: 1; overflow-y: auto; padding: 15px; padding-bottom: 120px; display: flex; flex-direction: column; gap: 15px; }

        /* --- Stratagem Bar --- */
        #strat-bar {
            background: #34495e; border-top: 1px solid #2c3e50;
            padding: 8px 10px; display: flex; gap: 10px; overflow-x: auto;
            white-space: nowrap; flex-shrink: 0; height: 50px; align-items: center;
            -webkit-overflow-scrolling: touch;
        }
        /* Hide scrollbar */
        #strat-bar::-webkit-scrollbar { display: none; }
        .strat-pill {
            color: #fff; padding: 6px 12px; border-radius: 6px;
            font-size: 0.75rem; font-weight: bold; border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); flex-shrink: 0; cursor: pointer;
        }
        .strat-pill.dg { background: var(--strat-dg); }
        .strat-pill.core { background: var(--strat-core); }

        /* --- Bottom Console (Sticky) --- */
        #command-console {
            height: 60px; background-color: var(--console-bg); color: var(--console-text);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; box-shadow: 0 -2px 10px rgba(0,0,0,0.3); flex-shrink: 0; z-index: 20;
        }
        .console-group { display: flex; align-items: center; gap: 15px; }
        .resource-box { display: flex; flex-direction: column; align-items: center; min-width: 50px; }
        .res-label { font-size: 0.6rem; color: #888; font-weight: bold; letter-spacing: 1px; }
        .res-val { font-size: 1.5rem; font-weight: 900; line-height: 1; color: var(--accent-color); }
        .res-controls { display: flex; gap: 5px; }
        .res-btn {
            background: #333; color: #fff; border: 1px solid #555; width: 24px; height: 24px;
            border-radius: 4px; font-weight: bold; cursor: pointer; display: grid; place-items: center;
        }
        .reset-btn { font-size: 0.7rem; color: #e74c3c; background: transparent; border: 1px solid #e74c3c; padding: 4px 8px; border-radius: 4px; cursor: pointer; }

        /* --- Cards & Components --- */
        .card { background: #fff; border-radius: 8px; padding: 12px; border: 1px solid var(--border-color); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        
        .tactics-card { background-color: #fff3cd; border: 1px solid #ffeeba; color: #856404; }
        .split-view { display: flex; gap: 15px; flex-wrap: wrap; }
        .split-col { flex: 1; min-width: 300px; display: flex; flex-direction: column; gap: 10px; }

        .stats-row { display: flex; gap: 1px; background: var(--header-color); border-radius: 6px; overflow: hidden; margin-bottom: 8px; }
        .stat-box { flex: 1; background: #fff; text-align: center; padding: 3px 0; }
        .stat-label { font-size: 0.6rem; font-weight: 800; color: #95a5a6; display: block; }
        .stat-val { font-size: 1rem; font-weight: 800; color: #2c3e50; }
        .invuln-box { background: var(--header-color); } .invuln-box .stat-val { color: #fff; }

        .wound-control { display: flex; align-items: center; justify-content: space-between; background: var(--stat-bg); padding: 5px 10px; border-radius: 6px; margin-bottom: 4px; }
        .wound-btn { width: 30px; height: 30px; border-radius: 50%; border: 1px solid #bdc3c7; background: #fff; font-weight: bold; cursor: pointer; display: grid; place-items: center; font-size: 1.2rem; touch-action: manipulation; }
        .wound-val { font-size: 1.2rem; font-weight: 800; width: 35px; text-align: center; }
        
        .weapon-row { margin-bottom: 8px; border-bottom: 1px dashed #eee; padding-bottom: 6px; }
        .weapon-header { display: flex; justify-content: space-between; align-items: baseline; }
        .weapon-name { font-weight: 800; color: #2c3e50; font-size: 0.9rem; }
        .profile-table { width: 100%; font-size: 0.85rem; text-align: center; border-collapse: collapse; border: 1px solid #eee; margin-top: 2px; }
        .profile-table th { background: #f8f9fa; color: #7f8c8d; padding: 2px; font-size: 0.65rem; }
        .profile-table td { padding: 4px; font-weight: 600; color: #2c3e50; }

        .ability { margin-bottom: 6px; padding-left: 8px; border-left: 3px solid #bdc3c7; }
        .ability-name { font-weight: 700; color: #34495e; font-size: 0.85rem; }
        .ability-desc { font-size: 0.8rem; color: #576574; }
        
        .active-phase { border-color: var(--highlight-color); background: #f0fff4; }
        .enhancement { border-color: #9b59b6; background: #f3e5f5; }
        .deadly-demise { color: #c0392b; font-weight: bold; display: none; text-align: center; font-size: 0.8rem; margin-top: 5px; animation: pulse 1s infinite; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* Keywords Styling */
        .k-lethal, .k-sus { color: #27ae60; } .k-anti, .k-dev { color: #c0392b; } .k-blast { color: #8e44ad; }
    </style>
</head>
<body>

<div id="app-container">
    <div id="phase-tracker">
        <div class="phase-info">
            <span id="turn-display" class="turn-label">SETUP</span>
            <div id="current-phase-name">DEPLOYMENT</div>
        </div>
        <button id="next-phase-btn">START GAME</button>
    </div>

    <div id="main-body">
        <aside id="unit-list"></aside>
        <div id="unit-details-wrapper">
            <div id="content-scroll"></div>
        </div>
    </div>

    <div id="strat-bar">
        <span style="color:rgba(255,255,255,0.5); font-size:0.8rem;">Awaiting Deployment...</span>
    </div>

    <div id="command-console">
        <div class="console-group">
            <button class="reset-btn" onclick="resetGame()">RESET</button>
        </div>
        <div class="console-group">
            <div class="resource-box">
                <span class="res-label">CP</span>
                <span class="res-val" id="cp-val">0</span>
                <div class="res-controls">
                    <div class="res-btn" onclick="modRes('cp', -1)">-</div>
                    <div class="res-btn" onclick="modRes('cp', 1)">+</div>
                </div>
            </div>
            <div class="resource-box" style="margin-left: 10px; border-left: 1px solid #333; padding-left: 15px;">
                <span class="res-label">VP</span>
                <span class="res-val" id="vp-val" style="color: #f1c40f;">0</span>
                <div class="res-controls">
                    <div class="res-btn" onclick="modRes('vp', -1)">-</div>
                    <div class="res-btn" onclick="modRes('vp', 5)">+5</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- 1. GAME DATA (THE CHOSEN) ---
    const PROFILES = {
        loc: {
            name: "Lord of Contagion",
            stats: { M: '5"', T: '6', Sv: '2+', W: '6', Ld: '6+', OC: '1', invuln: '4+' },
            wargear: [
                { name: 'Manreaper (Strike)', type: 'Melee', stats: { range: 'Melee', a: '5', ws: '2+', s: '9', ap: '-2', d: '3' }, kw: 'LETHAL HITS' },
                { name: 'Manreaper (Sweep)', type: 'Melee', stats: { range: 'Melee', a: '10', ws: '2+', s: '6', ap: '-1', d: '1' }, kw: 'LETHAL HITS' }
            ],
            abilities: [
                { name: 'Vector of Disease', desc: 'Leading Unit: Melee weapons get <strong>[SUSTAINED HITS 1]</strong> and <strong>[LANCE]</strong>.', phases: ['fight'] },
                { name: 'Unholy Resilience', desc: 'On death: Roll D6. 2+ return with 3 Wounds.', phases: ['any'] },
                { name: 'ENHANCEMENT: Warprot Talisman', desc: 'End of Opp Turn: If not in Engagement, enter Strategic Reserves.', phases: ['opponent_end'] }
            ]
        },
        lov: {
            name: "Lord of Virulence",
            stats: { M: '5"', T: '6', Sv: '2+', W: '6', Ld: '6+', OC: '1', invuln: '4+' },
            wargear: [
                { name: 'Twin Plague Spewer', type: 'Ranged', stats: { range: '12"', a: 'D6', bs: 'N/A', s: '5', ap: '-1', d: '1' }, kw: 'ANTI-INF 2+, IGNORES COVER, TORRENT, TWIN-LINKED' },
                { name: 'Power Fist', type: 'Melee', stats: { range: 'Melee', a: '5', ws: '2+', s: '8', ap: '-2', d: '2' }, kw: 'LETHAL HITS' }
            ],
            abilities: [
                { name: 'Virulent Aura', desc: 'Leading Unit: Reroll <strong>Wound rolls</strong> for ranged attacks.', phases: ['shooting', 'opp_shooting'] },
                { name: 'Blight Bombardment', desc: 'Start of Shooting: Select visible enemy < 30". Friendly Blast weapons reroll Hit. Others reroll 1s.', phases: ['shooting'] },
                { name: 'ENHANCEMENT: Helm of Fly King', desc: 'Leading Unit: Cannot be targeted by ranged unless attacker is within 18".', phases: ['opp_shooting'] }
            ]
        },
        typhus: {
            name: "Typhus",
            stats: { M: '5"', T: '6', Sv: '2+', W: '6', Ld: '6+', OC: '1', invuln: '4+' },
            wargear: [
                { name: 'Lakrimae (Strike)', type: 'Melee', stats: { range: 'Melee', a: '6', ws: '2+', s: '9', ap: '-2', d: '3' }, kw: 'LETHAL HITS' },
                { name: 'Lakrimae (Sweep)', type: 'Melee', stats: { range: 'Melee', a: '12', ws: '2+', s: '6', ap: '-1', d: '1' }, kw: 'LETHAL HITS' }
            ],
            abilities: [
                { name: 'Destroyer Hive', desc: 'Leading Unit: -1 to be Hit in Melee.', phases: ['fight', 'opp_fight'] },
                { name: 'Eater Plague', desc: 'Shooting Phase: Select visible enemy < 18". D6: 1=You take D3 MW. 2-5=Enemy takes D6 MW. 6=Enemy takes D3+3 MW.', phases: ['shooting'] }
            ]
        },
        deathshroud: {
            name: "Deathshroud Terms",
            stats: { M: '5"', T: '6', Sv: '2+', W: '4', Ld: '6+', OC: '1', invuln: '4+' },
            wargear: [
                { name: 'Plaguespurt Gauntlet', type: 'Ranged', stats: { range: '12"', a: 'D6', bs: 'N/A', s: '3', ap: '0', d: '1' }, kw: 'ANTI-INF 4+, IGNORES COVER, PISTOL, TORRENT' },
                { name: 'Manreaper (Strike)', type: 'Melee', stats: { range: 'Melee', a: '4', ws: '2+', s: '8', ap: '-2', d: '2' }, kw: 'LETHAL HITS' },
                { name: 'Manreaper (Sweep)', type: 'Melee', stats: { range: 'Melee', a: '8', ws: '3+', s: '4', ap: '-1', d: '1' }, kw: 'LETHAL HITS' }
            ],
            abilities: [
                { name: 'Silent Bodyguard', desc: 'Leader gets Feel No Pain 4+.', phases: ['any'] },
                { name: 'Death Approaches', desc: 'Deep Strike > 6" from Afflicted units.', phases: ['movement'] },
                { name: 'Icon of Despair', desc: 'Aura: Enemy within 6" -1 Leadership.', phases: ['aura'] }
            ]
        },
        poxwalkers: {
            name: "Poxwalkers",
            stats: { M: '4"', T: '4', Sv: '7+', W: '1', Ld: '8+', OC: '1', invuln: '6+' },
            wargear: [ { name: 'Improvised Weapon', type: 'Melee', stats: { range: 'Melee', a: '2', ws: '5+', s: '3', ap: '0', d: '1' }, kw: 'LETHAL HITS' } ],
            abilities: [
                { name: 'Curse of the Walking Pox', desc: 'Fight Phase: Kills return 1 model (Typhus kills count!).', phases: ['fight'] },
                { name: 'Feel No Pain 5+', desc: 'Core ability.', phases: ['any'] }
            ]
        },
        blightlords: {
            name: "Blightlord Terms",
            stats: { M: '5"', T: '6', Sv: '2+', W: '3', Ld: '6+', OC: '1', invuln: '4+' },
            wargear: [
                { name: 'Blight Launcher', type: 'Ranged', stats: { range: '24"', a: 'D3', bs: '3+', s: '6', ap: '-1', d: '2' }, kw: 'BLAST, LETHAL HITS' },
                { name: 'Reaper Autocannon', type: 'Ranged', stats: { range: '36"', a: '4', bs: '3+', s: '7', ap: '-1', d: '1' }, kw: 'DEV WOUNDS, SUSTAINED 1' },
                { name: 'Combi-bolter', type: 'Ranged', stats: { range: '24"', a: '2', bs: '3+', s: '4', ap: '0', d: '1' }, kw: 'LETHAL, RAPID FIRE 2' }
            ],
            abilities: [
                { name: 'Blistering Fusillade', desc: '+1 S and +1 AP vs Afflicted targets.', phases: ['shooting', 'opp_shooting'] }
            ]
        },
        spawn: {
            name: "Chaos Spawn",
            stats: { M: '8"', T: '5', Sv: '4+', W: '4', Ld: '7+', OC: '1', invuln: '5+' },
            wargear: [ { name: 'Hideous Mutations', type: 'Melee', stats: { range: 'Melee', a: 'D6+2', ws: '4+', s: '5', ap: '-1', d: '2' }, kw: '' } ],
            abilities: [ { name: 'Lethal Ichor', desc: 'Fight Phase: After being hit, roll 1D6 per enemy unit. 4+ = 1 MW.', phases: ['fight', 'opp_fight'] }, { name: 'FNP 5+', desc: '', phases: ['any'] } ]
        },
        drone: {
            name: "Foetid Bloat-drone",
            stats: { M: '10"', T: '9', Sv: '3+', W: '10', Ld: '6+', OC: '3', invuln: '5+' },
            wargear: [ { name: 'Heavy Blight Launcher', type: 'Ranged', stats: { range: '36"', a: 'D6+2', bs: '3+', s: '10', ap: '-2', d: '3' }, kw: 'BLAST, LETHAL HITS' } ],
            abilities: [ { name: 'Explosive Blight', desc: 'Kills spread Affliction to all units within 6" on a 5+.', phases: ['shooting'] }, { name: 'Deadly Demise D3', desc: '', phases: ['any'] } ]
        },
        pbc: {
            name: "Plagueburst Crawler",
            stats: { M: '10"', T: '10', Sv: '2+', W: '12', Ld: '6+', OC: '3', invuln: '5+' },
            wargear: [ { name: 'Plagueburst Mortar', type: 'Ranged', stats: { range: '48"', a: 'D6+3', bs: '3+', s: '8', ap: '-1', d: '2' }, kw: 'BLAST, INDIRECT, LETHAL' }, { name: 'Entropy Cannon', type: 'Ranged', stats: { range: '36"', a: '1', bs: '3+', s: '10', ap: '-3', d: 'D6+1' }, kw: 'LETHAL HITS' } ],
            abilities: [ { name: 'Spore-laced Shock Waves', desc: 'Mortar hits force Battleshock. 6+ (or 5+ if Afflicted) causes D3 MW.', phases: ['shooting'] } ]
        }
    };

    const TASK_FORCES = [
        {
            id: 'rules', name: 'üìú ARMY RULES', group: 'Reference',
            type: 'rules',
            content: `
                <div class="card tactics-card">
                    <h3>Skullsquirm Blight (Army Rule)</h3>
                    <p><strong>Effect:</strong> Enemy units in Contagion Range are <strong>Afflicted</strong> (-1 Toughness).</p>
                    <p><strong>Debuff:</strong> Afflicted units suffer <strong>-1 to Hit</strong>.</p>
                    <div style="margin-top:10px; background:rgba(0,0,0,0.05); padding:5px; border-radius:4px; text-align:center;">
                        <strong>CONTAGION RANGE</strong><br>
                        T1: 3" | T2: 6" | T3+: 9"
                    </div>
                </div>
                <div class="card tactics-card" style="margin-top:10px;">
                    <h3>Deadly Vectors (Detachment)</h3>
                    <p><strong>Timing:</strong> Opponent's Command Phase.</p>
                    <p><strong>Action:</strong> Roll 2D6 for every Afflicted enemy unit.</p>
                    <p><strong>Effect:</strong> If roll is 6 or less (subtract 1 if Below Half-strength), unit takes <strong>D3 Mortal Wounds</strong>.</p>
                </div>
            `
        },
        {
            id: 'tf_executioner', name: '‚öîÔ∏è EXECUTIONER BLOCK', group: 'Task Forces',
            type: 'combo',
            tactics: { title: 'MELEE BLENDER', desc: 'LoC gives [LANCE] & [SUSTAINED]. Scythes S8 wound T4 on 2+, T12 on 4+.' },
            units: [ { profile: 'loc', count: 1, label: 'Warlord' }, { profile: 'deathshroud', count: 6, label: 'Bodyguard' } ]
        },
        {
            id: 'tf_spotter', name: 'üéØ ARTILLERY SPOTTER', group: 'Task Forces',
            type: 'combo',
            tactics: { title: 'SPOT & OVERWATCH', desc: 'Use LoV "Blight Bombardment" to buff PBCs. Use Overwatch with Anti-Infantry 4+ Gauntlets (Reroll Wounds).' },
            units: [ { profile: 'lov', count: 1, label: 'Leader' }, { profile: 'deathshroud', count: 3, label: 'Bodyguard' } ]
        },
        {
            id: 'tf_tarpit', name: 'üßü THE TAR PIT', group: 'Task Forces',
            type: 'combo',
            tactics: { title: 'RESURRECTION LOOP', desc: 'Typhus Shooting + Fighting returns Poxwalkers. Poxwalker kills return Poxwalkers.' },
            units: [ { profile: 'typhus', count: 1, label: 'Leader' }, { profile: 'poxwalkers', count: 10, label: 'Bodyguard' } ]
        },
        { id: 'sq_blight', name: 'üõ°Ô∏è ANVIL (Blightlords)', group: 'Solo Operatives', type: 'single', profile: 'blightlords', count: 5 },
        { id: 'sq_ds_solo', name: 'üíÄ ACTION (Deathshroud)', group: 'Solo Operatives', type: 'single', profile: 'deathshroud', count: 3 },
        { id: 'veh_pbc1', name: 'üí• PBC 1', group: 'Vehicles', type: 'single', profile: 'pbc', count: 1 },
        { id: 'veh_pbc2', name: 'üí• PBC 2', group: 'Vehicles', type: 'single', profile: 'pbc', count: 1 },
        { id: 'veh_drone1', name: 'ü¶ü DRONE 1', group: 'Vehicles', type: 'single', profile: 'drone', count: 1 },
        { id: 'veh_drone2', name: 'ü¶ü DRONE 2', group: 'Vehicles', type: 'single', profile: 'drone', count: 1 },
        { id: 'veh_spawn', name: 'üëπ SPAWN (2)', group: 'Vehicles', type: 'single', profile: 'spawn', count: 2 }
    ];

    const PHASES = [
        { id: 'command', label: 'My Command', cp: true }, 
        { id: 'movement', label: 'My Move' }, { id: 'shooting', label: 'My Shoot' },
        { id: 'charge', label: 'My Charge' }, { id: 'fight', label: 'My Fight' },
        { id: 'opp_command', label: 'Opp Command', cp: true }, 
        { id: 'opp_movement', label: 'Opp Move' }, { id: 'opp_shooting', label: 'Opp Shoot' },
        { id: 'opp_charge', label: 'Opp Charge' }, { id: 'opp_fight', label: 'Opp Fight' },
        { id: 'opponent_end', label: 'End Opp Turn' }
    ];

    // --- 2. STRATAGEMS (UPDATED & DETAILED) ---
    const STRATAGEMS = {
        command: [
            { name: "Blooming Pestilence (1CP)", desc: "WHEN: Command Phase.\nTARGET: One DG Unit.\nEFFECT: Until next Command Phase, Aura ranges increase by 3\".", type: 'dg' },
            { name: "Signal Pox (1CP)", desc: "WHEN: Command Phase.\nTARGET: One visible enemy unit.\nEFFECT: That unit becomes AFFLICTED until your next Command Phase.", type: 'dg' },
            { name: "Command Re-roll (1CP)", desc: "WHEN: Any phase, after a roll.\nEFFECT: Re-roll 1 Hit, Wound, Damage, Save, Advance, Charge, or Hazard test.", type: 'core' },
            { name: "New Orders (1CP)", desc: "WHEN: Command Phase.\nTARGET: Unit in range of objective.\nEFFECT: If you control it, it remains under your control if you move away.", type: 'core' },
            { name: "Insane Bravery (1CP)", desc: "WHEN: Battleshock step.\nTARGET: Unit that failed Battleshock.\nEFFECT: It automatically passes.", type: 'core' }
        ],
        movement: [
            { name: "Blooming Pestilence (1CP)", desc: "WHEN: Command Phase (Lasts through move).\nEFFECT: Extends Aura ranges by 3\".", type: 'dg' }
        ],
        shooting: [
            { name: "Mortarion's Teachings (1CP)", desc: "WHEN: Start of Shooting Phase.\nTARGET: One DG Unit.\nEFFECT: Ranged weapons gain [SUSTAINED HITS 1]. If they already have it, Critical Hits trigger on 5+.", type: 'dg' },
            { name: "Blooming Pestilence (1CP)", desc: "(Active if used in Command Phase).", type: 'dg' },
            { name: "Grenade (1CP)", desc: "WHEN: Shooting Phase.\nTARGET: Grenades unit vs enemy within 8\".\nEFFECT: Roll 6D6. 4+ = 1 MW.", type: 'core' },
            { name: "Command Re-roll (1CP)", desc: "Re-roll Hit/Wound/Damage.", type: 'core' }
        ],
        charge: [
            { name: "Sickening Impact (1CP)", desc: "WHEN: Charge Phase, after a DG unit finishes a charge.\nTARGET: That DG unit.\nEFFECT: Roll D6 for each model in unit. 4+ = 1 MW to enemy within Engagement Range.", type: 'dg' },
            { name: "Tank Shock (1CP)", desc: "WHEN: Charge Phase.\nTARGET: Vehicle unit.\nEFFECT: Roll D6 equal to Toughness. 5+ = 1 MW (max 6).", type: 'core' },
            { name: "Heroic Intervention (2CP)", desc: "WHEN: Opponent Charge Phase.\nTARGET: Unit within 6\" of enemy.\nEFFECT: Charge immediately.", type: 'core' } // Note: Usually 2CP
        ],
        fight: [
            { name: "Grim Reapers (1CP)", desc: "WHEN: Fight Phase.\nTARGET: Deathshroud or Blightlord unit.\nEFFECT: Re-roll Hit rolls.", type: 'dg' },
            { name: "Undying Spite (1CP)", desc: "WHEN: Fight Phase, just after a DG Character is destroyed.\nEFFECT: Model fights on death before being removed.", type: 'dg' },
            { name: "Epic Challenge (1CP)", desc: "WHEN: Fight Phase.\nTARGET: Character.\nEFFECT: Melee attacks gain [PRECISION].", type: 'core' },
            { name: "Counter-Offensive (2CP)", desc: "WHEN: Fight Phase, after an enemy unit fights.\nEFFECT: Pick a unit to fight next.", type: 'core' }
        ],
        opp_movement: [
            { name: "Rapid Ingress (1CP)", desc: "WHEN: End of Opponent Movement.\nTARGET: Unit in Reserves.\nEFFECT: Deep Strike now (safe from shooting usually).", type: 'core' },
            { name: "Fire Overwatch (1CP)", desc: "WHEN: Start or End of Move.\nEFFECT: Shoot as if Shooting phase (Hit on 6s).", type: 'core' }
        ],
        opp_shooting: [
            { name: "Smokescreen (1CP)", desc: "WHEN: Opponent Shooting.\nTARGET: Smoke unit (Vehicle).\nEFFECT: Stealth (-1 to Hit) and Cover.", type: 'core' },
            { name: "Go To Ground (1CP)", desc: "WHEN: Opponent Shooting.\nTARGET: Infantry.\nEFFECT: Benefit of Cover and 6++ Invuln.", type: 'core' }
        ],
        opp_charge: [
             { name: "Heroic Intervention (2CP)", desc: "WHEN: Opponent Charge.\nTARGET: Unit within 6\" of enemy.\nEFFECT: Charge into combat.", type: 'core' },
             { name: "Fire Overwatch (1CP)", desc: "WHEN: Start or End of Charge move.\nEFFECT: Shoot on 6s.", type: 'core' }
        ],
        opp_fight: [
             { name: "Counter-Offensive (2CP)", desc: "WHEN: After enemy fights.\nEFFECT: Interrupt fight order.", type: 'core' }
        ]
    };

    // --- 3. STATE MANAGEMENT (PERSISTENCE) ---
    const STATE_KEY = 'dg_chosen_final_v1';
    
    let gameState = {
        turn: 0, cp: 0, vp: 0, phaseIdx: -1,
        activeId: 'rules', wounds: {} 
    };

    function saveState() {
        localStorage.setItem(STATE_KEY, JSON.stringify(gameState));
        updateConsole();
    }

    function loadState() {
        const saved = localStorage.getItem(STATE_KEY);
        if(saved) {
            try { gameState = JSON.parse(saved); } catch(e) { console.error(e); }
        }
        updateConsole();
        updatePhaseDisplay();
        updateStratBar();
    }

    function resetGame() {
        if(confirm("Reset Game? This clears all wounds, CP, and VP.")) {
            gameState = { turn: 0, cp: 0, vp: 0, phaseIdx: -1, activeId: 'rules', wounds: {} };
            saveState();
            loadView('rules');
            updatePhaseDisplay();
            updateStratBar();
        }
    }

    // --- 4. RENDER LOGIC ---
    
    // Side Bar
    const listEl = document.getElementById('unit-list');
    let lastGroup = '';
    TASK_FORCES.forEach(tf => {
        if(tf.group !== lastGroup) {
            const grp = document.createElement('div');
            grp.className = 'group-label';
            grp.textContent = tf.group;
            listEl.appendChild(grp);
            lastGroup = tf.group;
        }
        const btn = document.createElement('button');
        btn.id = `btn_${tf.id}`;
        btn.className = `unit-btn ${tf.type === 'combo' ? 'combo-btn' : ''} ${tf.id === 'rules' ? 'rules-btn' : ''}`;
        btn.textContent = tf.name;
        btn.onclick = () => loadView(tf.id);
        listEl.appendChild(btn);
    });

    function loadView(id) {
        gameState.activeId = id;
        saveState();
        
        // Highlight Sidebar
        document.querySelectorAll('.unit-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`btn_${id}`).classList.add('active');

        const data = TASK_FORCES.find(t => t.id === id);
        const container = document.getElementById('content-scroll');
        
        if(data.type === 'rules') {
            container.innerHTML = data.content;
            return;
        }

        let html = '';
        if(data.tactics) {
            html += `<div class="card tactics-card"><h3>‚ö° TACTIC: ${data.tactics.title}</h3><p style="margin:0; font-size:0.85rem;">${data.tactics.desc}</p></div>`;
        }

        const unitList = data.type === 'combo' ? data.units : [{ profile: data.profile, count: data.count, label: 'Unit' }];
        html += `<div class="split-view">`;
        
        unitList.forEach((u, idx) => {
            const prof = PROFILES[u.profile];
            const uid = `${id}_${idx}`; // Unique ID for wound persistence
            
            html += `<div class="split-col"><div class="card">`;
            html += `<div style="display:flex; justify-content:space-between; border-bottom:2px solid var(--bg-color); padding-bottom:5px; margin-bottom:8px;">
                <strong style="color:var(--accent-color); font-size:1rem;">${prof.name}</strong>
                <span style="font-size:0.7rem; background:#eee; padding:2px 6px; border-radius:4px; height:fit-content;">${u.label}</span>
            </div>`;

            // Stats
            html += `<div class="stats-row">
                <div class="stat-box"><span class="stat-label">M</span><div class="stat-val">${prof.stats.M}</div></div>
                <div class="stat-box"><span class="stat-label">T</span><div class="stat-val">${prof.stats.T}</div></div>
                <div class="stat-box"><span class="stat-label">Sv</span><div class="stat-val">${prof.stats.Sv}</div></div>
                <div class="stat-box"><span class="stat-label">W</span><div class="stat-val">${prof.stats.W}</div></div>
                <div class="stat-box"><span class="stat-label">Ld</span><div class="stat-val">${prof.stats.Ld}</div></div>
                <div class="stat-box"><span class="stat-label">OC</span><div class="stat-val">${prof.stats.OC}</div></div>
                <div class="stat-box invuln-box"><span class="stat-label">INV</span><div class="stat-val">${prof.stats.invuln}</div></div>
            </div>`;

            // Wounds
            html += `<div>`;
            const maxW = parseInt(prof.stats.W);
            for(let i=0; i<u.count; i++) {
                // Get saved wound value or default to max
                const wKey = `${uid}_${i}`;
                const curW = (gameState.wounds[wKey] !== undefined) ? gameState.wounds[wKey] : maxW;
                
                html += `<div class="wound-control">
                    <span style="font-size:0.8rem; color:#7f8c8d;">Model ${i+1}</span>
                    <div style="display:flex; gap:8px; align-items:center;">
                        <div class="wound-btn" onclick="modW('${wKey}', -1, ${maxW})">-</div>
                        <div class="wound-val" id="val_${wKey}" style="color:${curW===0?'#c0392b':'inherit'}">${curW}</div>
                        <div class="wound-btn" onclick="modW('${wKey}', 1, ${maxW})">+</div>
                    </div>
                </div>`;
            }
            // Deadly Demise check
            const ddVisible = checkDeadlyDemise(uid, u.count, maxW);
            html += `<div class="deadly-demise" id="dd_${uid}" style="display:${ddVisible?'block':'none'}">‚ö†Ô∏è DEADLY DEMISE CHECK</div>`;
            html += `</div>`;

            // Weapons & Abilities
            html += `<div style="margin-top:12px;">`;
            prof.wargear.forEach(w => {
                html += `<div class="weapon-row">
                    <div class="weapon-header"><div class="weapon-name">${w.name}</div></div>
                    <table class="profile-table">
                        <thead><tr><th>RNG</th><th>A</th><th>HIT</th><th>S</th><th>AP</th><th>D</th></tr></thead>
                        <tbody><tr><td>${w.stats.range}</td><td>${w.stats.a}</td><td>${w.stats.bs||w.stats.ws}</td><td>${w.stats.s}</td><td>${w.stats.ap}</td><td>${w.stats.d}</td></tr></tbody>
                    </table>
                    <div style="font-size:0.7rem; margin-top:2px;">${formatKw(w.kw)}</div>
                </div>`;
            });
            
            prof.abilities.forEach(a => {
                const pId = (gameState.phaseIdx >= 0) ? PHASES[gameState.phaseIdx].id : '';
                const active = a.phases.includes(pId) || a.phases.includes('any');
                html += `<div class="ability ${active?'active-phase':''} ${a.name.includes('ENHANCEMENT')?'enhancement':''}">
                    <div class="ability-name">${a.name}</div><div class="ability-desc">${a.desc}</div>
                </div>`;
            });
            html += `</div></div></div>`;
        });
        html += `</div>`;
        container.innerHTML = html;
    }

    function updateStratBar() {
        const bar = document.getElementById('strat-bar');
        if(gameState.phaseIdx === -1) {
            bar.innerHTML = '<span style="color:rgba(255,255,255,0.5); font-size:0.8rem;">Awaiting Deployment...</span>';
            return;
        }

        const pId = PHASES[gameState.phaseIdx].id;
        // Merge generic phases for Stratagems (e.g., all 'movement' strats apply to 'my_movement')
        let key = pId; 
        const strats = STRATAGEMS[key] || [];

        if(strats.length === 0) {
            bar.innerHTML = '<span style="color:rgba(255,255,255,0.5); font-size:0.8rem;">NO STRATAGEMS AVAILABLE</span>';
            return;
        }

        let html = '';
        strats.forEach(s => {
            // SANITIZE STRINGS FOR ONCLICK
            const safeName = s.name.replace(/'/g, "\\'");
            const safeDesc = s.desc.replace(/'/g, "\\'").replace(/\n/g, "<br>");
            
            html += `<div class="strat-pill ${s.type}" onclick="showStrat('${safeName}', '${safeDesc}')">${s.name}</div>`;
        });
        bar.innerHTML = html;
    }
    
    function showStrat(name, desc) {
        // Simple alert for now, could be a modal
        alert(`${name}\n\n${desc.replace(/<br>/g, "\n")}`);
    }

    // --- 5. GAME ENGINE LOGIC ---

    function modW(key, diff, max) {
        // Init if undefined
        if(gameState.wounds[key] === undefined) gameState.wounds[key] = max;
        
        let v = gameState.wounds[key] + diff;
        if(v < 0) v = 0;
        if(v > max) v = max;
        
        gameState.wounds[key] = v;
        saveState();
        
        // Update UI
        const el = document.getElementById(`val_${key}`);
        if(el) {
            el.innerText = v;
            el.style.color = (v === 0) ? '#c0392b' : 'inherit';
        }

        // Check DD
        const baseUid = key.substring(0, key.lastIndexOf('_'));
        if(v === 0) {
            const ddEl = document.getElementById(`dd_${baseUid}`);
            if(ddEl) ddEl.style.display = 'block';
        }
    }

    function checkDeadlyDemise(uid, count, maxW) {
        for(let i=0; i<count; i++) {
            const k = `${uid}_${i}`;
            if(gameState.wounds[k] !== undefined && gameState.wounds[k] === 0) return true;
        }
        return false;
    }

    function modRes(type, diff) {
        if(type === 'cp') gameState.cp += diff;
        if(type === 'vp') gameState.vp += diff;
        if(gameState.cp < 0) gameState.cp = 0;
        if(gameState.vp < 0) gameState.vp = 0;
        saveState();
    }

    function updateConsole() {
        document.getElementById('cp-val').innerText = gameState.cp;
        document.getElementById('vp-val').innerText = gameState.vp;
    }

    function updatePhaseDisplay() {
        const btn = document.getElementById('next-phase-btn');
        const turnDisplay = document.getElementById('turn-display');
        const phaseName = document.getElementById('current-phase-name');

        if(gameState.phaseIdx === -1) {
            turnDisplay.innerText = "PRE-GAME";
            phaseName.innerText = "DEPLOYMENT";
            btn.innerText = "START GAME";
        } else {
            const p = PHASES[gameState.phaseIdx];
            turnDisplay.innerText = `TURN ${gameState.turn}`;
            phaseName.innerText = p.label;
            btn.innerText = "NEXT PHASE";
        }
    }

    // PHASE & CP ENGINE
    document.getElementById('next-phase-btn').onclick = () => {
        // Wake Lock Trigger (iOS requires user interaction)
        requestWakeLock();

        // Start Game
        if(gameState.phaseIdx === -1) {
            gameState.phaseIdx = 0;
            gameState.turn = 1;
            gameState.cp++; // 10th Ed: Gain 1 CP at start of Command Phase
            alert("BATTLE STARTED: +1 CP (My Command)");
        } else {
            // Move Phase
            gameState.phaseIdx = (gameState.phaseIdx + 1) % PHASES.length;
            const p = PHASES[gameState.phaseIdx];

            // Turn Cycle
            if(gameState.phaseIdx === 0) gameState.turn++;

            // CP Logic (10th Ed: +1 CP in both Command Phases)
            if(p.cp) {
                gameState.cp++;
                // Optional visual feedback
                const btn = document.getElementById('cp-val');
                btn.style.color = '#2ecc71';
                setTimeout(() => btn.style.color = '', 500);
            }
        }
        
        saveState();
        updatePhaseDisplay();
        updateStratBar();
        loadView(gameState.activeId); // Refresh for phase highlights
    };

    function formatKw(str) {
        if(!str) return '';
        return str.split(', ').map(k => {
            if(k.includes('LETHAL') || k.includes('SUSTAINED')) return `<span class="k-lethal">${k}</span>`;
            if(k.includes('ANTI') || k.includes('DEV')) return `<span class="k-anti">${k}</span>`;
            if(k.includes('BLAST') || k.includes('TORRENT') || k.includes('INDIRECT')) return `<span class="k-blast">${k}</span>`;
            return k;
        }).join(', ');
    }

    // --- 5. WAKE LOCK API ---
    async function requestWakeLock() {
        try {
            if ('wakeLock' in navigator) {
                await navigator.wakeLock.request('screen');
            }
        } catch (err) { console.log('Wake Lock Error', err); }
    }

    // INIT
    loadState();
    if(gameState.activeId) loadView(gameState.activeId);

</script>
</body>
</html>
