<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Chosen - Tournament Dashboard</title>
    <style>
        :root {
            --bg-color: #f0f2f5; --surface-color: #ffffff; --text-color: #1c1e21;
            --header-color: #2c3e50; --accent-color: #2980b9; --border-color: #ccd0d5;
            --highlight-color: #27ae60; --highlight-text: #fff;
            --stat-bg: #ecf0f1;
            --kw-pos: #27ae60; --kw-neg: #c0392b; --kw-spec: #8e44ad;
            --phase-active: #f39c12;
            --aura-border: #3498db;
        }

        html, body {
            height: 100%; margin: 0; overflow: hidden; background-color: var(--bg-color);
            color: var(--text-color); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            font-size: 15px; line-height: 1.5;
        }

        /* --- Layout --- */
        #phase-tracker {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 20px; background-color: var(--header-color); color: #fff;
            height: 60px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        #current-phase-name { margin: 0; font-size: 1.2rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
        #next-phase-btn {
            background-color: var(--accent-color); color: #fff; border: none;
            padding: 8px 16px; border-radius: 4px; font-weight: 600; cursor: pointer;
        }

        .app-body { display: flex; height: calc(100vh - 60px); }
        
        /* --- Sidebar --- */
        #unit-list {
            width: 280px; flex-shrink: 0; background-color: #e4e6eb; 
            border-right: 1px solid var(--border-color); overflow-y: auto; padding: 10px;
        }
        .unit-btn {
            display: block; width: 100%; padding: 10px 12px; margin-bottom: 6px;
            background: #fff; border: 1px solid #ccc; border-radius: 6px;
            text-align: left; font-weight: 600; color: #333; cursor: pointer;
            transition: all 0.1s;
        }
        .unit-btn:hover { border-color: var(--accent-color); }
        .unit-btn.active { background-color: var(--header-color); color: #fff; border-color: var(--header-color); }
        .unit-btn.rules-btn { border-left: 4px solid var(--kw-neg); background-color: #fff3cd; color: #555; }

        /* --- Main Content --- */
        #unit-details-wrapper { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; background: var(--bg-color); }
        
        #header-bar {
            background: #fff; padding: 15px 25px; border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
        }
        #unit-name { font-size: 1.8rem; font-weight: 800; color: var(--header-color); margin: 0; }
        
        #content-scroll { flex-grow: 1; overflow-y: auto; padding: 20px; display: flex; gap: 20px; align-items: flex-start; }
        .col { flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 15px; }

        /* --- Cards & Stats --- */
        .card { background: #fff; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 15px; border: 1px solid var(--border-color); }
        .card h3 { margin-top: 0; border-bottom: 2px solid var(--bg-color); padding-bottom: 8px; color: var(--accent-color); font-size: 0.95rem; text-transform: uppercase; }
        
        .stats-row { display: flex; gap: 2px; background: var(--header-color); padding: 2px; border-radius: 6px; overflow: hidden; margin-bottom: 10px; }
        .stat-box { flex: 1; background: #fff; text-align: center; padding: 5px 0; }
        .stat-label { font-size: 0.7rem; font-weight: 700; color: #777; display: block; }
        .stat-val { font-size: 1.2rem; font-weight: 800; color: #000; }
        .invuln-box { background: var(--header-color); color: #fff; }
        .invuln-box .stat-label { color: #ccc; }
        .invuln-box .stat-val { color: #fff; }

        /* --- Weapons --- */
        .weapon-row { margin-bottom: 12px; border-bottom: 1px dashed #eee; padding-bottom: 8px; }
        .weapon-name { font-weight: 800; font-size: 1rem; color: #2c3e50; display: flex; justify-content: space-between; }
        .weapon-tags { font-size: 0.75rem; color: #666; margin-top: 2px; font-style: italic; }
        .profile-table { width: 100%; font-size: 0.9rem; text-align: center; border-collapse: collapse; margin-top: 5px; }
        .profile-table th { background: var(--stat-bg); font-size: 0.7rem; color: #555; padding: 4px; }
        .profile-table td { border: 1px solid #eee; font-weight: 600; padding: 6px; }

        /* --- Abilities --- */
        .ability-item { margin-bottom: 10px; border-left: 3px solid transparent; padding-left: 10px; }
        .ability-title { font-weight: 700; color: var(--header-color); cursor: pointer; display: flex; align-items: center; }
        .ability-desc { font-size: 0.9rem; color: #444; margin-top: 4px; }
        
        /* --- Highlights --- */
        .active-phase { border-color: var(--phase-active); background-color: #fffaf0; box-shadow: -3px 0 0 var(--phase-active); }
        .aura-active { border-left-color: var(--aura-border); }
        .enhancement { background-color: #fce4ec; border-left: 3px solid #d81b60; padding: 8px; border-radius: 4px; }
        
        /* --- Wound Tracker --- */
        .tracker-row { display: flex; justify-content: space-between; align-items: center; background: var(--stat-bg); padding: 8px; border-radius: 6px; margin-bottom: 4px; }
        .tracker-btn { width: 30px; height: 30px; border-radius: 50%; border: 1px solid #ccc; cursor: pointer; font-weight: bold; background: #fff; }
        .tracker-val { font-size: 1.2rem; font-weight: bold; width: 40px; text-align: center; }
        .deadly-demise-alert { color: #c0392b; font-weight: bold; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        /* --- Keywords --- */
        .kw-tag { display: inline-block; background: #eee; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; margin-right: 4px; color: #555; }
        .kw-faction { background: var(--header-color); color: #fff; }
        
        /* Keyword Colors */
        .k-lethal { color: var(--kw-pos); } .k-sustained { color: var(--kw-pos); }
        .k-anti { color: var(--kw-neg); } .k-dev { color: var(--kw-neg); }
        .k-blast { color: var(--kw-spec); } .k-torrent { color: var(--kw-spec); }
    </style>
</head>
<body>

<div id="phase-tracker">
    <div>
        <div style="font-size: 0.7rem; opacity: 0.8;">CURRENT PHASE</div>
        <h2 id="current-phase-name">SETUP</h2>
    </div>
    <button id="next-phase-btn">NEXT PHASE</button>
</div>

<div class="app-body">
    <aside id="unit-list"></aside>
    
    <div id="unit-details-wrapper">
        <div id="header-bar">
            <h1 id="unit-name">Select Unit</h1>
            <div id="controls">
                <label style="font-size: 0.8rem; font-weight: bold;">Models:</label>
                <select id="model-count-select"></select>
            </div>
        </div>
        <div id="content-scroll">
            </div>
    </div>
</div>

<script>
    // --- DATA SOURCE: THE CHOSEN (COMPETITIVE) ---
    // Updated with specific unit counts for wound tracking
    
    // Shared Data Profiles
    const profiles = {
        deathshroud: {
            stats: { M: '5"', T: '6', Sv: '2+', W: '4', Ld: '6+', OC: '1', invuln: '4+' },
            wargear: [
                { name: 'Plaguespurt Gauntlet', type: 'Ranged', profiles: [{ range: '12"', a: 'D6', bs: 'N/A', s: '3', ap: '0', d: '1', kw: 'ANTI-INF 4+, IGNORES COVER, PISTOL, TORRENT' }] },
                { name: 'Manreaper - Strike', type: 'Melee', profiles: [{ range: 'Melee', a: '4', ws: '2+', s: '8', ap: '-2', d: '2', kw: 'LETHAL HITS' }] },
                { name: 'Manreaper - Sweep', type: 'Melee', profiles: [{ range: 'Melee', a: '8', ws: '3+', s: '4', ap: '-1', d: '1', kw: 'LETHAL HITS' }] }
            ],
            abilities: [
                { name: 'Deep Strike', type: 'core', phases: ['movement', 'setup'] },
                { name: 'Silent Bodyguard', desc: 'While a Character leads this unit, that Character has <strong>Feel No Pain 4+</strong>.', phases: ['any'] },
                { name: 'Death Approaches', desc: 'Deep Strike can be set up > 6" away from Afflicted units (instead of 9").', phases: ['movement'] },
                { name: 'Icon of Despair (Aura)', desc: 'Enemy units within 6" worsen Leadership by 1.', phases: ['aura'] }
            ],
            keywords: ['INFANTRY', 'TERMINATOR', 'CHAOS', 'NURGLE', 'DEATHSHROUD']
        },
        drone: {
            stats: { M: '10"', T: '9', Sv: '3+', W: '10', Ld: '6+', OC: '3', invuln: '5+' },
            wargear: [
                { name: 'Heavy Blight Launcher', type: 'Ranged', profiles: [{ range: '36"', a: 'D6+2', bs: '3+', s: '10', ap: '-2', d: '3', kw: 'BLAST, LETHAL HITS' }] },
                { name: 'Plague Probe', type: 'Melee', profiles: [{ range: 'Melee', a: '3', ws: '3+', s: '6', ap: '-1', d: '1', kw: 'LETHAL HITS' }] }
            ],
            abilities: [
                { name: 'Deadly Demise D3', type: 'core', phases: ['any'] },
                { name: 'Explosive Blight', desc: 'Shooting Phase: If this model destroys a unit, roll D6 (+1 if unit was Afflicted). On 5+, each enemy unit within 6" of destroyed model becomes <strong>Afflicted</strong>.', phases: ['shooting'] }
            ],
            keywords: ['VEHICLE', 'FLY', 'DAEMON', 'CHAOS', 'NURGLE', 'FOETID BLOAT-DRONE']
        },
        pbc: {
            stats: { M: '10"', T: '10', Sv: '2+', W: '12', Ld: '6+', OC: '3', invuln: '5+' },
            wargear: [
                { name: 'Plagueburst Mortar', type: 'Ranged', profiles: [{ range: '48"', a: 'D6+3', bs: '3+', s: '8', ap: '-1', d: '2', kw: 'BLAST, INDIRECT, LETHAL HITS' }] },
                { name: 'Entropy Cannon', type: 'Ranged', profiles: [{ range: '36"', a: '1', bs: '3+', s: '10', ap: '-3', d: 'D6+1', kw: 'LETHAL HITS' }] },
                { name: 'Heavy Slugger', type: 'Ranged', profiles: [{ range: '36"', a: '4', bs: '3+', s: '5', ap: '-1', d: '1', kw: 'LETHAL HITS' }] },
                { name: 'Armoured Tracks', type: 'Melee', profiles: [{ range: 'Melee', a: '3', ws: '4+', s: '6', ap: '0', d: '1', kw: '' }] }
            ],
            abilities: [
                { name: 'Deadly Demise D3', type: 'core', phases: ['any'] },
                { name: 'Spore-laced Shock Waves', desc: 'Start of Shooting: When selecting Mortar target, roll D6 for target and units within 3" (Add 1 if Afflicted). On 6+, unit suffers D3 Mortal Wounds after attacks resolve.', phases: ['shooting'] }
            ],
            keywords: ['VEHICLE', 'DAEMON', 'CHAOS', 'NURGLE', 'PLAGUEBURST CRAWLER']
        }
    };

    const codexData = [
        {
            id: 'rules', name: 'üìú ARMY & DETACHMENT', type: 'rule',
            content: `
                <div class="card active-phase">
                    <h3>Skullsquirm Blight (Army Rule)</h3>
                    <p><strong>If your Army Faction is Death Guard:</strong></p>
                    <ul>
                        <li><strong>Nurgle's Gift (Aura):</strong> Enemy units within Contagion Range are <strong>Afflicted</strong> (-1 Toughness).</li>
                        <li><strong>Skullsquirm Blight Effect:</strong> While an enemy unit is Afflicted, subtract 1 from the Hit roll when models in that unit make an attack.</li>
                    </ul>
                    <div style="background:#eee; padding:5px; font-size:0.8rem; text-align:center; margin-top:5px;">
                        <strong>Contagion Range:</strong> T1: 3" | T2: 6" | T3+: 9"
                    </div>
                </div>
                <div class="card">
                    <h3>Deadly Vectors (Detachment)</h3>
                    <p><strong>In your opponent's Command Phase:</strong></p>
                    <p>Roll 2D6 for each Afflicted enemy unit.</p>
                    <ul>
                        <li>Subtract 1 from result if unit is Below Half-strength.</li>
                        <li>If result is <strong>6 or less</strong>, that unit suffers <strong>D3 Mortal Wounds</strong>.</li>
                        <li>(Opponent must take Battle-shock tests for units below half-strength as normal).</li>
                    </ul>
                </div>
            `
        },
        {
            id: 'loc', name: 'Lord of Contagion (Warlord)',
            stats: { M: '5"', T: '6', Sv: '2+', W: '6', Ld: '6+', OC: '1', invuln: '4+' },
            wargear: [
                { name: 'Manreaper - Strike', type: 'Melee', profiles: [{ range: 'Melee', a: '5', ws: '2+', s: '9', ap: '-2', d: '3', kw: 'LETHAL HITS' }] },
                { name: 'Manreaper - Sweep', type: 'Melee', profiles: [{ range: 'Melee', a: '10', ws: '2+', s: '6', ap: '-1', d: '1', kw: 'LETHAL HITS' }] }
            ],
            abilities: [
                { name: 'Deep Strike / Leader', type: 'core', phases: ['movement', 'setup'] },
                { name: 'Vector of Disease', desc: 'While leading a unit, melee weapons in that unit have <strong>[SUSTAINED HITS 1]</strong> and <strong>[LANCE]</strong> (+1 Wound).', phases: ['fight'] },
                { name: 'Unholy Resilience', desc: 'First time destroyed: Roll D6 at end of phase. On 2+, set back up as close as possible (not in Engagement) with 3 Wounds.', phases: ['any'] },
                { name: 'ENHANCEMENT: Warprot Talisman', desc: '<strong>Once per battle</strong>, at the end of your opponent‚Äôs turn, if bearer‚Äôs unit is not within Engagement Range, remove it from play and place into <strong>Strategic Reserves</strong>.', phases: ['opponent_end'] }
            ],
            keywords: ['INFANTRY', 'CHARACTER', 'TERMINATOR', 'CHAOS', 'NURGLE', 'LORD OF CONTAGION'],
            leader: 'Blightlord Terminators, Deathshroud Terminators'
        },
        {
            id: 'lov', name: 'Lord of Virulence',
            stats: { M: '5"', T: '6', Sv: '2+', W: '6', Ld: '6+', OC: '1', invuln: '4+' },
            wargear: [
                { name: 'Twin Plague Spewer', type: 'Ranged', profiles: [{ range: '12"', a: 'D6', bs: 'N/A', s: '5', ap: '-1', d: '1', kw: 'ANTI-INF 2+, IGNORES COVER, TORRENT, TWIN-LINKED' }] },
                { name: 'Power Fist', type: 'Melee', profiles: [{ range: 'Melee', a: '5', ws: '2+', s: '8', ap: '-2', d: '2', kw: 'LETHAL HITS' }] }
            ],
            abilities: [
                { name: 'Deep Strike / Leader', type: 'core', phases: ['movement', 'setup'] },
                { name: 'Virulent Aura', desc: 'While leading a unit, re-roll the <strong>Wound roll</strong> for ranged attacks.', phases: ['shooting', 'opp_shooting'] },
                { name: 'Blight Bombardment', desc: 'Start of Shooting: Select visible enemy < 30". Friendly DG Blast weapons re-roll Hit roll. Non-Blast re-roll Hit rolls of 1.', phases: ['shooting'] },
                { name: 'ENHANCEMENT: Helm of The Fly King', desc: 'While leading a unit, models in that unit <strong>cannot be targeted by ranged attacks</strong> unless the attacker is within 18".', phases: ['opp_shooting'] }
            ],
            keywords: ['INFANTRY', 'CHARACTER', 'TERMINATOR', 'CHAOS', 'NURGLE', 'LORD OF VIRULENCE'],
            leader: 'Blightlord Terminators, Deathshroud Terminators'
        },
        {
            id: 'typhus', name: 'Typhus',
            stats: { M: '5"', T: '6', Sv: '2+', W: '6', Ld: '6+', OC: '1', invuln: '4+' },
            wargear: [
                { name: 'Lakrimae - Strike', type: 'Melee', profiles: [{ range: 'Melee', a: '6', ws: '2+', s: '9', ap: '-2', d: '3', kw: 'LETHAL HITS' }] },
                { name: 'Lakrimae - Sweep', type: 'Melee', profiles: [{ range: 'Melee', a: '12', ws: '2+', s: '6', ap: '-1', d: '1', kw: 'LETHAL HITS' }] }
            ],
            abilities: [
                { name: 'Deep Strike / Leader', type: 'core', phases: ['movement', 'setup'] },
                { name: 'Destroyer Hive', desc: 'While leading a unit, subtract 1 from the Hit roll for melee attacks targeting that unit.', phases: ['fight'] },
                { name: 'Eater Plague (Psychic)', desc: 'Your Shooting Phase: Select visible enemy < 18". Roll D6. <br><strong>1:</strong> You take D3 MW. <br><strong>2-5:</strong> Enemy takes D6 MW. <br><strong>6:</strong> Enemy takes D3+3 MW.', phases: ['shooting'] }
            ],
            keywords: ['INFANTRY', 'CHARACTER', 'EPIC HERO', 'PSYKER', 'TERMINATOR', 'CHAOS', 'NURGLE', 'TYPHUS'],
            leader: 'Blightlords, Deathshroud, Poxwalkers'
        },
        {
            id: 'blightlords', name: 'Blightlord Terminators (5)',
            stats: { M: '5"', T: '6', Sv: '2+', W: '3', Ld: '6+', OC: '1', invuln: '4+' },
            wargear: [
                { name: 'Combi-bolter', type: 'Ranged', profiles: [{ range: '24"', a: '2', bs: '3+', s: '4', ap: '0', d: '1', kw: 'LETHAL HITS, RAPID FIRE 2' }] },
                { name: 'Blight Launcher', type: 'Ranged', profiles: [{ range: '24"', a: 'D3', bs: '3+', s: '6', ap: '-1', d: '2', kw: 'BLAST, LETHAL HITS' }] },
                { name: 'Reaper Autocannon', type: 'Ranged', profiles: [{ range: '36"', a: '4', bs: '3+', s: '7', ap: '-1', d: '1', kw: 'DEV WOUNDS, SUSTAINED HITS 1' }] },
                { name: 'Plague Spewer', type: 'Ranged', profiles: [{ range: '12"', a: 'D6', bs: 'N/A', s: '5', ap: '-1', d: '1', kw: 'ANTI-INF 2+, IGNORES COVER, TORRENT' }] },
                { name: 'Flail of Corruption', type: 'Melee', profiles: [{ range: 'Melee', a: '6', ws: '3+', s: '5', ap: '-1', d: '2', kw: 'LETHAL HITS' }] },
                { name: 'Bubotic Blade', type: 'Melee', profiles: [{ range: 'Melee', a: '3', ws: '3+', s: '5', ap: '-2', d: '2', kw: 'LETHAL HITS' }] }
            ],
            abilities: [
                { name: 'Deep Strike', type: 'core', phases: ['movement', 'setup'] },
                { name: 'Blistering Fusillade', desc: 'If 5+ models OR Led by Character: Ranged attacks vs Afflicted units get <strong>+1 Strength and +1 AP</strong>.', phases: ['shooting', 'opp_shooting'] }
            ],
            keywords: ['INFANTRY', 'TERMINATOR', 'CHAOS', 'NURGLE', 'BLIGHTLORD'],
            defaultCount: 5
        },
        {
            id: 'dst_1', name: 'Deathshroud (3)',
            ...profiles.deathshroud,
            defaultCount: 3
        },
        {
            id: 'dst_2', name: 'Deathshroud (6)',
            ...profiles.deathshroud,
            defaultCount: 6
        },
        {
            id: 'dst_3', name: 'Deathshroud (3)',
            ...profiles.deathshroud,
            defaultCount: 3
        },
        {
            id: 'spawn', name: 'Chaos Spawn (2)',
            stats: { M: '8"', T: '5', Sv: '4+', W: '4', Ld: '7+', OC: '1', invuln: '5+' },
            wargear: [
                { name: 'Hideous Mutations', type: 'Melee', profiles: [{ range: 'Melee', a: 'D6+2', ws: '4+', s: '5', ap: '-1', d: '2', kw: '' }] }
            ],
            abilities: [
                { name: 'FNP 5+ / Scouts 6" / Deadly Demise 1', type: 'core', phases: ['any', 'setup'] },
                { name: 'Lethal Ichor', desc: '<strong>Melee Phase:</strong> After an attacking unit finishes attacks, roll one D6 per attacking unit (max 6D6). For each 4+, attacking unit suffers 1 Mortal Wound.', phases: ['fight'] }
            ],
            keywords: ['BEAST', 'CHAOS', 'NURGLE', 'CHAOS SPAWN'],
            defaultCount: 2
        },
        {
            id: 'drone_1', name: 'Foetid Bloat-drone 1',
            ...profiles.drone,
            defaultCount: 1
        },
        {
            id: 'drone_2', name: 'Foetid Bloat-drone 2',
            ...profiles.drone,
            defaultCount: 1
        },
        {
            id: 'pbc_1', name: 'Plagueburst Crawler 1',
            ...profiles.pbc,
            defaultCount: 1
        },
        {
            id: 'pbc_2', name: 'Plagueburst Crawler 2',
            ...profiles.pbc,
            defaultCount: 1
        },
        {
            id: 'pox', name: 'Poxwalkers (10)',
            stats: { M: '4"', T: '4', Sv: '7+', W: '1', Ld: '8+', OC: '1', invuln: '6+' },
            wargear: [
                { name: 'Improvised Weapon', type: 'Melee', profiles: [{ range: 'Melee', a: '2', ws: '5+', s: '3', ap: '0', d: '1', kw: 'LETHAL HITS' }] }
            ],
            abilities: [
                { name: 'FNP 5+ / Infiltrators', type: 'core', phases: ['any', 'setup'] },
                { name: 'Curse of the Walking Pox', desc: 'Each time a model in this unit destroys an enemy INFANTRY model (excluding Monster/Vehicle), return 1 destroyed Poxwalker. (Typhus kills count).', phases: ['fight'] }
            ],
            keywords: ['INFANTRY', 'CHAOS', 'NURGLE', 'POXWALKERS'],
            defaultCount: 10
        }
    ];

    // --- APP LOGIC ---
    const phases = [
        { id: 'command', label: 'Command' },
        { id: 'movement', label: 'Movement' },
        { id: 'shooting', label: 'Shooting' },
        { id: 'charge', label: 'Charge' },
        { id: 'fight', label: 'Fight' },
        { id: 'opp_command', label: 'Opp Command' },
        { id: 'opp_movement', label: 'Opp Movement' },
        { id: 'opp_shooting', label: 'Opp Shooting' },
        { id: 'opp_charge', label: 'Opp Charge' },
        { id: 'opp_fight', label: 'Opp Fight' },
        { id: 'opponent_end', label: 'End of Opp Turn' }
    ];
    let currentPhaseIdx = 0;
    let activeUnitId = 'rules';

    const els = {
        phaseName: document.getElementById('current-phase-name'),
        nextPhaseBtn: document.getElementById('next-phase-btn'),
        unitList: document.getElementById('unit-list'),
        content: document.getElementById('content-scroll'),
        unitName: document.getElementById('unit-name'),
        modelCountSelect: document.getElementById('model-count-select')
    };

    function renderUnitList() {
        els.unitList.innerHTML = '';
        codexData.forEach(u => {
            const btn = document.createElement('button');
            btn.className = `unit-btn ${u.type === 'rule' ? 'rules-btn' : ''}`;
            btn.textContent = u.name;
            btn.onclick = () => loadUnit(u.id);
            if(u.id === activeUnitId) btn.classList.add('active');
            els.unitList.appendChild(btn);
        });
    }

    function loadUnit(id) {
        activeUnitId = id;
        renderUnitList();
        const unit = codexData.find(u => u.id === id);
        els.unitName.textContent = unit.name;
        
        // Rules View
        if (unit.type === 'rule') {
            els.modelCountSelect.parentElement.style.display = 'none';
            els.content.innerHTML = unit.content;
            return;
        }

        // Standard View
        els.modelCountSelect.parentElement.style.display = 'block';
        
        // Build Select
        let opts = '';
        const def = unit.defaultCount || 1;
        for(let i=1; i<=20; i++) opts += `<option value="${i}" ${i===def?'selected':''}>${i}</option>`;
        els.modelCountSelect.innerHTML = opts;
        
        renderDetails(unit, def);
    }

    function renderDetails(unit, count) {
        const pId = phases[currentPhaseIdx].id;
        
        // Column 1: Stats & Wounds
        let c1 = `<div class="col">`;
        
        // Stats
        c1 += `<div class="stats-row">
            <div class="stat-box"><span class="stat-label">M</span><span class="stat-val">${unit.stats.M}</span></div>
            <div class="stat-box"><span class="stat-label">T</span><span class="stat-val">${unit.stats.T}</span></div>
            <div class="stat-box"><span class="stat-label">Sv</span><span class="stat-val">${unit.stats.Sv}</span></div>
            <div class="stat-box"><span class="stat-label">W</span><span class="stat-val">${unit.stats.W}</span></div>
            <div class="stat-box"><span class="stat-label">Ld</span><span class="stat-val">${unit.stats.Ld}</span></div>
            <div class="stat-box"><span class="stat-label">OC</span><span class="stat-val">${unit.stats.OC}</span></div>
            <div class="stat-box invuln-box"><span class="stat-label">INV</span><span class="stat-val">${unit.stats.invuln}</span></div>
        </div>`;

        // Wounds
        c1 += `<div class="card"><h3>Wounds Tracker</h3>`;
        const maxW = parseInt(unit.stats.W);
        for(let i=0; i<count; i++) {
            c1 += `<div class="tracker-row" id="w-row-${i}">
                <span style="font-size:0.8rem; font-weight:bold; color:#666;">Model ${i+1}</span>
                <div style="display:flex; align-items:center; gap:10px;">
                    <button class="tracker-btn" onclick="modW(${i}, -1)">-</button>
                    <div class="tracker-val" id="w-val-${i}">${maxW}</div>
                    <button class="tracker-btn" onclick="modW(${i}, 1)">+</button>
                </div>
            </div>`;
        }
        // Deadly Demise check
        const hasDD = unit.abilities.some(a => a.name.includes('Deadly Demise'));
        if(hasDD) c1 += `<div id="dd-alert" class="deadly-demise-alert" style="display:none; text-align:center; margin-top:5px;">‚ö†Ô∏è DEADLY DEMISE TRIGGER?</div>`;
        c1 += `</div>`; // End Card

        // Weapons
        c1 += `<div class="card"><h3>Weapons</h3>`;
        unit.wargear.forEach(w => {
            c1 += `<div class="weapon-row">
                <div class="weapon-name">
                    ${w.name} 
                    <span style="font-size:0.8rem; color:#888;">${w.type}</span>
                </div>
                <table class="profile-table">
                    <thead><tr><th>Rng</th><th>A</th><th>${w.profiles[0].bs ? 'BS' : 'WS'}</th><th>S</th><th>AP</th><th>D</th></tr></thead>
                    <tbody>
                        ${w.profiles.map(p => `
                        <tr>
                            <td>${p.range}</td><td>${p.a}</td><td>${p.bs || p.ws}</td><td>${p.s}</td><td>${p.ap}</td><td>${p.d}</td>
                        </tr>
                        `).join('')}
                    </tbody>
                </table>
                <div class="weapon-tags">${formatKeywords(w.profiles[0].kw)}</div>
            </div>`;
        });
        c1 += `</div></div>`; // End Col 1

        // Column 2: Abilities
        let c2 = `<div class="col">`;
        c2 += `<div class="card"><h3>Abilities</h3>`;
        
        // Aura Check
        const auraAbilities = unit.abilities.filter(a => a.phases.includes('aura'));
        if(auraAbilities.length > 0) {
            c2 += `<div class="ability-item aura-active">
                <div class="ability-title" style="color:#2980b9;">Nurgle's Gift (Aura)</div>
                <div class="ability-desc">Enemies within Contagion Range are <strong>Afflicted</strong> (-1 Toughness).</div>
            </div>`;
        }

        unit.abilities.forEach(a => {
            const isActive = a.phases.includes(pId) || a.phases.includes('any');
            const isEnhancement = a.name.includes('ENHANCEMENT');
            c2 += `<div class="ability-item ${isActive ? 'active-phase' : ''} ${isEnhancement ? 'enhancement' : ''}">
                <div class="ability-title">
                    ${a.name} 
                    ${isActive ? '<span style="margin-left:auto; font-size:0.7rem; background:#f39c12; color:#fff; padding:2px 4px; border-radius:4px;">ACTIVE</span>' : ''}
                </div>
                <div class="ability-desc">${a.desc || ''}</div>
            </div>`;
        });
        c2 += `</div>`;

        // Keywords
        c2 += `<div class="card" style="font-size:0.8rem;">
            <strong>KEYWORDS:</strong><br>
            ${unit.keywords.map(k => `<span class="kw-tag">${k}</span>`).join('')}
            <br><br>
            <span class="kw-tag kw-faction">FACTION: DEATH GUARD</span>
            ${unit.leader ? `<div style="margin-top:10px; border-top:1px solid #eee; paddingTop:5px;"><strong>LEADER:</strong> ${unit.leader}</div>` : ''}
        </div>`;
        
        c2 += `</div>`; // End Col 2

        els.content.innerHTML = c1 + c2;
    }

    // Helper: Colorize Weapon Keywords
    function formatKeywords(str) {
        if(!str) return '';
        return str.split(', ').map(k => {
            if(k.includes('LETHAL') || k.includes('SUSTAINED')) return `<span class="k-lethal">${k}</span>`;
            if(k.includes('ANTI') || k.includes('DEV')) return `<span class="k-anti">${k}</span>`;
            if(k.includes('BLAST') || k.includes('TORRENT') || k.includes('INDIRECT')) return `<span class="k-blast">${k}</span>`;
            return k;
        }).join(', ');
    }

    // Helper: Wound Tracking
    window.modW = (idx, amount) => {
        const el = document.getElementById(`w-val-${idx}`);
        const unit = codexData.find(u => u.id === activeUnitId);
        const max = parseInt(unit.stats.W);
        let cur = parseInt(el.textContent);
        cur = Math.max(0, Math.min(max, cur + amount));
        el.textContent = cur;
        
        // Deadly Demise Check
        const ddAlert = document.getElementById('dd-alert');
        if(ddAlert) {
            const isZero = cur === 0;
            // Simple check: if any model is 0 and unit has DD
            const anyZero = Array.from(document.querySelectorAll('.tracker-val')).some(div => parseInt(div.textContent) === 0);
            ddAlert.style.display = anyZero ? 'block' : 'none';
        }
    };

    // Phase Navigation
    els.nextPhaseBtn.onclick = () => {
        currentPhaseIdx = (currentPhaseIdx + 1) % phases.length;
        els.phaseName.textContent = phases[currentPhaseIdx].label;
        if(activeUnitId !== 'rules') {
            const u = codexData.find(u => u.id === activeUnitId);
            const count = parseInt(els.modelCountSelect.value);
            renderDetails(u, count);
        }
    };

    // Model Count Change
    els.modelCountSelect.onchange = (e) => {
        const u = codexData.find(u => u.id === activeUnitId);
        renderDetails(u, parseInt(e.target.value));
    };

    // Init
    renderUnitList();
    loadUnit('rules');

</script>
</body>
</html>
