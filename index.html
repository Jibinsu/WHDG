<!DOCTYPE html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Chosen</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="The Chosen">
    <link rel="apple-touch-icon" href="https://img.icons8.com/color/48/biohazard.png"> 

    <style>
        :root {
            --bg-color: #eaedf0; --surface-color: #ffffff; --text-color: #1c1e21;
            --header-color: #2c3e50; --accent-color: #2980b9; --border-color: #cfd8dc;
            --highlight-color: #27ae60; --alert-color: #c0392b;
            --tactics-bg: #fff3cd; --tactics-border: #ffeeba; --tactics-text: #856404;
            --stat-bg: #f1f2f6;
        }

        html, body {
            height: 100%; margin: 0; overflow: hidden; background-color: var(--bg-color);
            color: var(--text-color); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            font-size: 14px; line-height: 1.4;
        }

        /* --- Layout --- */
        #phase-tracker {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 20px; background-color: var(--header-color); color: #fff;
            height: 55px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            flex-shrink: 0;
        }
        #current-phase-name { margin: 0; font-size: 1.1rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
        #next-phase-btn {
            background-color: var(--accent-color); color: #fff; border: none;
            padding: 6px 14px; border-radius: 4px; font-weight: 600; cursor: pointer;
            font-size: 0.85rem; transition: background 0.2s;
        }
        #next-phase-btn:hover { background-color: #3498db; }

        .app-body { display: flex; height: calc(100vh - 55px); }
        
        /* --- Sidebar --- */
        #unit-list {
            width: 260px; flex-shrink: 0; background-color: #dfe4ea; 
            border-right: 1px solid var(--border-color); overflow-y: auto; padding: 10px;
        }
        .group-label { font-size: 0.75rem; font-weight: 800; color: #7f8c8d; margin: 10px 0 4px 4px; text-transform: uppercase; }
        .unit-btn {
            display: block; width: 100%; padding: 12px 12px; margin-bottom: 6px;
            background: #fff; border: 1px solid #b0b8be; border-radius: 6px;
            text-align: left; font-weight: 700; color: #2c3e50; cursor: pointer;
            transition: all 0.15s; font-size: 0.9rem; position: relative;
        }
        .unit-btn:hover { border-color: var(--accent-color); transform: translateX(2px); }
        .unit-btn.active { background-color: var(--header-color); color: #fff; border-color: var(--header-color); }
        .unit-btn.rules-btn { border-left: 4px solid var(--alert-color); background-color: #fff; }
        .unit-btn.combo-btn { border-left: 4px solid var(--highlight-color); }

        /* --- Main Content --- */
        #unit-details-wrapper { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; background: var(--bg-color); }
        
        #content-scroll { flex-grow: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 20px; }

        /* --- Cards --- */
        .card { background: #fff; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); padding: 15px; border: 1px solid var(--border-color); position: relative; }
        .card h3 { margin-top: 0; border-bottom: 2px solid var(--bg-color); padding-bottom: 8px; color: var(--header-color); font-size: 1rem; text-transform: uppercase; letter-spacing: 0.5px; }
        
        /* Tactics Card */
        .tactics-card { background-color: var(--tactics-bg); border: 1px solid var(--tactics-border); color: var(--tactics-text); }
        .tactics-card h3 { border-bottom-color: rgba(0,0,0,0.1); color: #533f03; }
        .synergy-tag { display: inline-block; background: rgba(0,0,0,0.1); padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 0.75rem; margin-right: 5px; }

        /* Stats Grid */
        .stats-row { display: flex; gap: 1px; background: var(--header-color); border-radius: 6px; overflow: hidden; margin-bottom: 10px; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .stat-box { flex: 1; background: #fff; text-align: center; padding: 4px 0; }
        .stat-label { font-size: 0.65rem; font-weight: 800; color: #95a5a6; display: block; }
        .stat-val { font-size: 1.1rem; font-weight: 800; color: #2c3e50; }
        .invuln-box { background: var(--header-color); }
        .invuln-box .stat-val { color: #fff; }

        /* Wounds */
        .wound-control { display: flex; align-items: center; justify-content: space-between; background: var(--stat-bg); padding: 6px 10px; border-radius: 6px; margin-bottom: 5px; }
        .wound-btn { width: 28px; height: 28px; border-radius: 50%; border: 1px solid #bdc3c7; background: #fff; font-weight: bold; cursor: pointer; display: grid; place-items: center; }
        .wound-val { font-size: 1.2rem; font-weight: 800; width: 40px; text-align: center; }
        .model-label { font-weight: 600; font-size: 0.85rem; color: #7f8c8d; }

        /* Weapons */
        .weapon-row { margin-bottom: 10px; border-bottom: 1px dashed #eee; padding-bottom: 8px; }
        .weapon-header { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 4px; }
        .weapon-name { font-weight: 800; color: #2c3e50; font-size: 0.95rem; }
        .weapon-type { font-size: 0.7rem; color: #95a5a6; font-weight: 600; text-transform: uppercase; }
        .profile-table { width: 100%; font-size: 0.85rem; text-align: center; border-collapse: collapse; border: 1px solid #eee; }
        .profile-table th { background: #f8f9fa; color: #7f8c8d; padding: 4px; font-size: 0.7rem; border-bottom: 1px solid #eee; }
        .profile-table td { padding: 6px; font-weight: 600; color: #2c3e50; }
        .kw-list { font-size: 0.75rem; margin-top: 4px; line-height: 1.3; }

        /* Abilities */
        .ability { margin-bottom: 8px; padding-left: 10px; border-left: 3px solid #bdc3c7; }
        .ability-name { font-weight: 700; color: #34495e; cursor: pointer; font-size: 0.9rem; }
        .ability-desc { font-size: 0.85rem; color: #576574; margin-top: 2px; }
        
        .active-phase { border-color: var(--highlight-color); background: #f0fff4; }
        .enhancement { border-color: #9b59b6; background: #f3e5f5; }

        /* Split Layout for Combined Units */
        .split-view { display: flex; gap: 20px; flex-wrap: wrap; }
        .split-col { flex: 1; min-width: 300px; display: flex; flex-direction: column; gap: 15px; }

        /* Keyword Styling */
        .k-lethal { color: #27ae60; font-weight: 700; }
        .k-sus { color: #27ae60; font-weight: 700; }
        .k-anti { color: #c0392b; font-weight: 700; }
        .k-dev { color: #c0392b; font-weight: 700; }
        .k-blast { color: #8e44ad; font-weight: 700; }
        
        .deadly-demise { color: #c0392b; font-weight: bold; display: none; text-align: center; font-size: 0.8rem; margin-top: 5px; }
    </style>
</head>
<body>

<div id="phase-tracker">
    <div>
        <span style="font-size: 0.7rem; opacity: 0.7; letter-spacing: 1px;">CURRENT PHASE</span>
        <div id="current-phase-name">SETUP</div>
    </div>
    <button id="next-phase-btn">NEXT PHASE ></button>
</div>

<div class="app-body">
    <aside id="unit-list"></aside>
    <div id="unit-details-wrapper">
        <div id="content-scroll"></div>
    </div>
</div>

<script>
    // --- SHARED PROFILES ---
    const PROFILES = {
        loc: {
            name: "Lord of Contagion",
            stats: { M: '5"', T: '6', Sv: '2+', W: '6', Ld: '6+', OC: '1', invuln: '4+' },
            wargear: [
                { name: 'Manreaper (Strike)', type: 'Melee', stats: { range: 'Melee', a: '5', ws: '2+', s: '9', ap: '-2', d: '3' }, kw: 'LETHAL HITS' },
                { name: 'Manreaper (Sweep)', type: 'Melee', stats: { range: 'Melee', a: '10', ws: '2+', s: '6', ap: '-1', d: '1' }, kw: 'LETHAL HITS' }
            ],
            abilities: [
                { name: 'Vector of Disease', desc: 'Leading Unit: Melee weapons get <strong>[SUSTAINED HITS 1]</strong> and <strong>[LANCE]</strong>.', phases: ['fight'] },
                { name: 'Unholy Resilience', desc: 'On death: Roll D6. 2+ return with 3 Wounds.', phases: ['any'] },
                { name: 'ENHANCEMENT: Warprot Talisman', desc: 'End of Opp Turn: If not in Engagement, enter Strategic Reserves.', phases: ['opponent_end'] }
            ]
        },
        lov: {
            name: "Lord of Virulence",
            stats: { M: '5"', T: '6', Sv: '2+', W: '6', Ld: '6+', OC: '1', invuln: '4+' },
            wargear: [
                { name: 'Twin Plague Spewer', type: 'Ranged', stats: { range: '12"', a: 'D6', bs: 'N/A', s: '5', ap: '-1', d: '1' }, kw: 'ANTI-INF 2+, IGNORES COVER, TORRENT, TWIN-LINKED' },
                { name: 'Power Fist', type: 'Melee', stats: { range: 'Melee', a: '5', ws: '2+', s: '8', ap: '-2', d: '2' }, kw: 'LETHAL HITS' }
            ],
            abilities: [
                { name: 'Virulent Aura', desc: 'Leading Unit: Reroll <strong>Wound rolls</strong> for ranged attacks.', phases: ['shooting', 'opp_shooting'] },
                { name: 'Blight Bombardment', desc: 'Start of Shooting: Select visible enemy < 30". Friendly Blast weapons reroll Hit. Others reroll 1s.', phases: ['shooting'] },
                { name: 'ENHANCEMENT: Helm of Fly King', desc: 'Leading Unit: Cannot be targeted by ranged unless attacker is within 18".', phases: ['opp_shooting'] }
            ]
        },
        typhus: {
            name: "Typhus",
            stats: { M: '5"', T: '6', Sv: '2+', W: '6', Ld: '6+', OC: '1', invuln: '4+' },
            wargear: [
                { name: 'Lakrimae (Strike)', type: 'Melee', stats: { range: 'Melee', a: '6', ws: '2+', s: '9', ap: '-2', d: '3' }, kw: 'LETHAL HITS' },
                { name: 'Lakrimae (Sweep)', type: 'Melee', stats: { range: 'Melee', a: '12', ws: '2+', s: '6', ap: '-1', d: '1' }, kw: 'LETHAL HITS' }
            ],
            abilities: [
                { name: 'Destroyer Hive', desc: 'Leading Unit: -1 to be Hit in Melee.', phases: ['fight', 'opp_fight'] },
                { name: 'Eater Plague', desc: 'Shooting Phase: Select visible enemy < 18". D6: 1=You take D3 MW. 2-5=Enemy takes D6 MW. 6=Enemy takes D3+3 MW.', phases: ['shooting'] }
            ]
        },
        deathshroud: {
            name: "Deathshroud Terminators",
            stats: { M: '5"', T: '6', Sv: '2+', W: '4', Ld: '6+', OC: '1', invuln: '4+' },
            wargear: [
                { name: 'Plaguespurt Gauntlet', type: 'Ranged', stats: { range: '12"', a: 'D6', bs: 'N/A', s: '3', ap: '0', d: '1' }, kw: 'ANTI-INF 4+, IGNORES COVER, PISTOL, TORRENT' },
                { name: 'Manreaper (Strike)', type: 'Melee', stats: { range: 'Melee', a: '4', ws: '2+', s: '8', ap: '-2', d: '2' }, kw: 'LETHAL HITS' },
                { name: 'Manreaper (Sweep)', type: 'Melee', stats: { range: 'Melee', a: '8', ws: '3+', s: '4', ap: '-1', d: '1' }, kw: 'LETHAL HITS' }
            ],
            abilities: [
                { name: 'Silent Bodyguard', desc: 'Leader gets Feel No Pain 4+.', phases: ['any'] },
                { name: 'Death Approaches', desc: 'Deep Strike > 6" from Afflicted units.', phases: ['movement'] },
                { name: 'Icon of Despair', desc: 'Aura: Enemy within 6" -1 Leadership.', phases: ['aura'] }
            ]
        },
        poxwalkers: {
            name: "Poxwalkers",
            stats: { M: '4"', T: '4', Sv: '7+', W: '1', Ld: '8+', OC: '1', invuln: '6+' },
            wargear: [ { name: 'Improvised Weapon', type: 'Melee', stats: { range: 'Melee', a: '2', ws: '5+', s: '3', ap: '0', d: '1' }, kw: 'LETHAL HITS' } ],
            abilities: [
                { name: 'Curse of the Walking Pox', desc: 'Fight Phase: Kills return 1 model (Typhus kills count!).', phases: ['fight'] },
                { name: 'Feel No Pain 5+', desc: 'Core ability.', phases: ['any'] }
            ]
        },
        blightlords: {
            name: "Blightlord Terminators",
            stats: { M: '5"', T: '6', Sv: '2+', W: '3', Ld: '6+', OC: '1', invuln: '4+' },
            wargear: [
                { name: 'Blight Launcher', type: 'Ranged', stats: { range: '24"', a: 'D3', bs: '3+', s: '6', ap: '-1', d: '2' }, kw: 'BLAST, LETHAL HITS' },
                { name: 'Reaper Autocannon', type: 'Ranged', stats: { range: '36"', a: '4', bs: '3+', s: '7', ap: '-1', d: '1' }, kw: 'DEV WOUNDS, SUSTAINED 1' },
                { name: 'Combi-bolter', type: 'Ranged', stats: { range: '24"', a: '2', bs: '3+', s: '4', ap: '0', d: '1' }, kw: 'LETHAL, RAPID FIRE 2' }
            ],
            abilities: [
                { name: 'Blistering Fusillade', desc: '+1 S and +1 AP vs Afflicted targets.', phases: ['shooting', 'opp_shooting'] }
            ]
        },
        spawn: {
            name: "Chaos Spawn",
            stats: { M: '8"', T: '5', Sv: '4+', W: '4', Ld: '7+', OC: '1', invuln: '5+' },
            wargear: [ { name: 'Hideous Mutations', type: 'Melee', stats: { range: 'Melee', a: 'D6+2', ws: '4+', s: '5', ap: '-1', d: '2' }, kw: '' } ],
            abilities: [ { name: 'Lethal Ichor', desc: 'Fight Phase: After being hit, roll 1D6 per enemy unit. 4+ = 1 MW.', phases: ['fight', 'opp_fight'] }, { name: 'FNP 5+', desc: '', phases: ['any'] } ]
        },
        drone: {
            name: "Foetid Bloat-drone",
            stats: { M: '10"', T: '9', Sv: '3+', W: '10', Ld: '6+', OC: '3', invuln: '5+' },
            wargear: [ { name: 'Heavy Blight Launcher', type: 'Ranged', stats: { range: '36"', a: 'D6+2', bs: '3+', s: '10', ap: '-2', d: '3' }, kw: 'BLAST, LETHAL HITS' } ],
            abilities: [ { name: 'Explosive Blight', desc: 'Kills spread Affliction to all units within 6" on a 5+.', phases: ['shooting'] }, { name: 'Deadly Demise D3', desc: '', phases: ['any'] } ]
        },
        pbc: {
            name: "Plagueburst Crawler",
            stats: { M: '10"', T: '10', Sv: '2+', W: '12', Ld: '6+', OC: '3', invuln: '5+' },
            wargear: [ { name: 'Plagueburst Mortar', type: 'Ranged', stats: { range: '48"', a: 'D6+3', bs: '3+', s: '8', ap: '-1', d: '2' }, kw: 'BLAST, INDIRECT, LETHAL' }, { name: 'Entropy Cannon', type: 'Ranged', stats: { range: '36"', a: '1', bs: '3+', s: '10', ap: '-3', d: 'D6+1' }, kw: 'LETHAL HITS' } ],
            abilities: [ { name: 'Spore-laced Shock Waves', desc: 'Mortar hits force Battleshock. 6+ (or 5+ if Afflicted) causes D3 MW.', phases: ['shooting'] } ]
        }
    };

    // --- TASK FORCE COMPOSITION ---
    const TASK_FORCES = [
        {
            id: 'rules', name: 'üìú ARMY RULES', group: 'Reference',
            type: 'rules',
            content: `
                <div class="card tactics-card">
                    <h3>Skullsquirm Blight (Army Rule)</h3>
                    <p><strong>Effect:</strong> Enemy units in Contagion Range are <strong>Afflicted</strong> (-1 Toughness).</p>
                    <p><strong>Debuff:</strong> Afflicted units suffer <strong>-1 to Hit</strong>.</p>
                    <div style="margin-top:10px; background:rgba(0,0,0,0.05); padding:5px; border-radius:4px; text-align:center;">
                        <strong>CONTAGION RANGE</strong><br>
                        T1: 3" | T2: 6" | T3+: 9"
                    </div>
                </div>
                <div class="card tactics-card" style="margin-top:10px;">
                    <h3>Deadly Vectors (Detachment)</h3>
                    <p><strong>Timing:</strong> Opponent's Command Phase.</p>
                    <p><strong>Action:</strong> Roll 2D6 for every Afflicted enemy unit.</p>
                    <p><strong>Effect:</strong> If roll is 6 or less (subtract 1 if Below Half-strength), unit takes <strong>D3 Mortal Wounds</strong>.</p>
                </div>
            `
        },
        {
            id: 'tf_executioner', name: '‚öîÔ∏è EXECUTIONER BLOCK', group: 'Task Forces',
            type: 'combo',
            tactics: {
                title: 'THE MELEE BLENDER',
                desc: '<strong>The Loop:</strong> LoC gives [LANCE]. Scythes become S8 +1 to Wound. <br><span class="synergy-tag">VS T4</span> Wound on 2+. <span class="synergy-tag">VS T8-T11</span> Wound on 3+. <span class="synergy-tag">VS T12+</span> Wound on 4+.<br><strong>Outcome:</strong> You can kill Knights/Tanks in one charge.'
            },
            units: [
                { profile: 'loc', count: 1, label: 'Warlord' },
                { profile: 'deathshroud', count: 6, label: 'Bodyguard' }
            ]
        },
        {
            id: 'tf_spotter', name: 'üéØ ARTILLERY SPOTTER', group: 'Task Forces',
            type: 'combo',
            tactics: {
                title: 'OVERWATCH & SPOTTING',
                desc: '<strong>Spotting:</strong> Use LoV ability "Blight Bombardment" first. Grants PBCs rerolls.<br><strong>Overwatch:</strong> LoV gives unit Reroll Wounds. Gauntlets are Anti-Infantry 4+. <br><span class="synergy-tag">RESULT</span> You auto-hit and reroll wounds wounding on 4+ vs Infantry.'
            },
            units: [
                { profile: 'lov', count: 1, label: 'Leader' },
                { profile: 'deathshroud', count: 3, label: 'Bodyguard' }
            ]
        },
        {
            id: 'tf_tarpit', name: 'üßü THE TAR PIT', group: 'Task Forces',
            type: 'combo',
            tactics: {
                title: 'THE RESURRECTION LOOP',
                desc: '<strong>Interaction:</strong> Typhus leads Poxwalkers.<br>1. Shoot Eater Plague. Kills return Poxwalkers.<br>2. Fight with Typhus. Kills return Poxwalkers.<br>3. Fight with Poxwalkers. Kills return Poxwalkers.<br><strong>Defense:</strong> Unit is -1 to be Hit.'
            },
            units: [
                { profile: 'typhus', count: 1, label: 'Leader' },
                { profile: 'poxwalkers', count: 10, label: 'Bodyguard' }
            ]
        },
        { id: 'sq_blight', name: 'üõ°Ô∏è ANVIL (Blightlords)', group: 'Solo Operatives', type: 'single', profile: 'blightlords', count: 5 },
        { id: 'sq_ds_solo', name: 'üíÄ ACTION (Deathshroud)', group: 'Solo Operatives', type: 'single', profile: 'deathshroud', count: 3 },
        { id: 'veh_pbc1', name: 'üí• PBC 1', group: 'Vehicles', type: 'single', profile: 'pbc', count: 1 },
        { id: 'veh_pbc2', name: 'üí• PBC 2', group: 'Vehicles', type: 'single', profile: 'pbc', count: 1 },
        { id: 'veh_drone1', name: 'ü¶ü DRONE 1', group: 'Vehicles', type: 'single', profile: 'drone', count: 1 },
        { id: 'veh_drone2', name: 'ü¶ü DRONE 2', group: 'Vehicles', type: 'single', profile: 'drone', count: 1 },
        { id: 'veh_spawn', name: 'üëπ SPAWN (2)', group: 'Vehicles', type: 'single', profile: 'spawn', count: 2 }
    ];

    const PHASES = [
        { id: 'command', label: 'Command' }, { id: 'movement', label: 'Movement' }, { id: 'shooting', label: 'Shooting' },
        { id: 'charge', label: 'Charge' }, { id: 'fight', label: 'Fight' },
        { id: 'opp_movement', label: 'Opp Move' }, { id: 'opp_shooting', label: 'Opp Shoot' },
        { id: 'opp_charge', label: 'Opp Charge' }, { id: 'opp_fight', label: 'Opp Fight' },
        { id: 'opponent_end', label: 'End Opp Turn' }
    ];
    
    let currentPhaseIndex = 0;
    let activeId = 'rules';
    
    // Init Sidebar
    const listEl = document.getElementById('unit-list');
    let lastGroup = '';
    TASK_FORCES.forEach(tf => {
        if(tf.group !== lastGroup) {
            const grp = document.createElement('div');
            grp.className = 'group-label';
            grp.textContent = tf.group;
            listEl.appendChild(grp);
            lastGroup = tf.group;
        }
        const btn = document.createElement('button');
        btn.className = `unit-btn ${tf.type === 'combo' ? 'combo-btn' : ''} ${tf.id === 'rules' ? 'rules-btn' : ''}`;
        btn.textContent = tf.name;
        btn.onclick = () => loadView(tf.id);
        listEl.appendChild(btn);
    });

    function loadView(id) {
        activeId = id;
        document.querySelectorAll('.unit-btn').forEach(b => b.classList.remove('active'));
        // Find button to highlight (simple match)
        // Re-render content
        const data = TASK_FORCES.find(t => t.id === id);
        const container = document.getElementById('content-scroll');
        
        if(data.type === 'rules') {
            container.innerHTML = data.content;
            return;
        }

        let html = '';
        
        // 1. Tactics Card (if combo)
        if(data.tactics) {
            html += `<div class="card tactics-card">
                <h3>‚ö° TACTICAL SYNERGY: ${data.tactics.title}</h3>
                <p style="margin:0; font-size:0.9rem;">${data.tactics.desc}</p>
            </div>`;
        }

        // 2. Render Units (Loop for combos, once for single)
        const unitList = data.type === 'combo' ? data.units : [{ profile: data.profile, count: data.count, label: 'Unit' }];
        
        html += `<div class="split-view">`;
        
        unitList.forEach((u, idx) => {
            const prof = PROFILES[u.profile];
            const uid = `${id}_${idx}`; // Unique ID for wound tracking
            
            html += `<div class="split-col"><div class="card">`;
            
            // Header
            html += `<div style="display:flex; justify-content:space-between; border-bottom:2px solid var(--bg-color); padding-bottom:5px; margin-bottom:10px;">
                <strong style="color:var(--accent-color); font-size:1.1rem;">${prof.name}</strong>
                <span style="font-size:0.8rem; background:#eee; padding:2px 6px; border-radius:4px; height:fit-content;">${u.label}</span>
            </div>`;

            // Stats
            html += `<div class="stats-row">
                <div class="stat-box"><span class="stat-label">M</span><div class="stat-val">${prof.stats.M}</div></div>
                <div class="stat-box"><span class="stat-label">T</span><div class="stat-val">${prof.stats.T}</div></div>
                <div class="stat-box"><span class="stat-label">Sv</span><div class="stat-val">${prof.stats.Sv}</div></div>
                <div class="stat-box"><span class="stat-label">W</span><div class="stat-val">${prof.stats.W}</div></div>
                <div class="stat-box"><span class="stat-label">Ld</span><div class="stat-val">${prof.stats.Ld}</div></div>
                <div class="stat-box"><span class="stat-label">OC</span><div class="stat-val">${prof.stats.OC}</div></div>
                <div class="stat-box invuln-box"><span class="stat-label">INV</span><div class="stat-val">${prof.stats.invuln}</div></div>
            </div>`;

            // Wounds
            html += `<div>`;
            const maxW = parseInt(prof.stats.W);
            for(let i=0; i<u.count; i++) {
                html += `<div class="wound-control">
                    <span class="model-label">Model ${i+1}</span>
                    <div style="display:flex; gap:8px; align-items:center;">
                        <div class="wound-btn" onclick="modW('${uid}_${i}', -1)">-</div>
                        <div class="wound-val" id="w_${uid}_${i}">${maxW}</div>
                        <div class="wound-btn" onclick="modW('${uid}_${i}', 1)">+</div>
                    </div>
                </div>`;
            }
            html += `<div class="deadly-demise" id="dd_${uid}">‚ö†Ô∏è DEADLY DEMISE CHECK</div>`;
            html += `</div>`;

            // Weapons
            html += `<div style="margin-top:15px;">`;
            prof.wargear.forEach(w => {
                html += `<div class="weapon-row">
                    <div class="weapon-header">
                        <div class="weapon-name">${w.name}</div>
                        <div class="weapon-type">${w.type}</div>
                    </div>
                    <table class="profile-table">
                        <thead><tr><th>RNG</th><th>A</th><th>HIT</th><th>S</th><th>AP</th><th>D</th></tr></thead>
                        <tbody><tr><td>${w.stats.range}</td><td>${w.stats.a}</td><td>${w.stats.ws||w.stats.bs}</td><td>${w.stats.s}</td><td>${w.stats.ap}</td><td>${w.stats.d}</td></tr></tbody>
                    </table>
                    <div class="kw-list">${formatKw(w.kw)}</div>
                </div>`;
            });
            html += `</div>`;

            // Abilities
            html += `<div style="margin-top:15px;">`;
            prof.abilities.forEach(a => {
                const curP = PHASES[currentPhaseIndex].id;
                const active = a.phases.includes(curP) || a.phases.includes('any');
                html += `<div class="ability ${active?'active-phase':''} ${a.name.includes('ENHANCEMENT')?'enhancement':''}">
                    <div class="ability-name">${a.name}</div>
                    <div class="ability-desc">${a.desc}</div>
                </div>`;
            });
            html += `</div>`;

            html += `</div></div>`; // End Card & Col
        });
        
        html += `</div>`;
        container.innerHTML = html;
    }

    // --- UTILS ---
    function modW(id, diff) {
        const el = document.getElementById('w_'+id);
        let v = parseInt(el.innerText) + diff;
        if(v < 0) v = 0; 
        // Max cap omitted for speed, assume user knows
        el.innerText = v;
        
        // DD Check
        if(v === 0) {
            // Find parent container ID
            const baseId = id.substring(0, id.lastIndexOf('_'));
            const ddEl = document.getElementById('dd_'+baseId);
            if(ddEl) ddEl.style.display = 'block';
        }
    }

    function formatKw(str) {
        if(!str) return '';
        return str.split(', ').map(k => {
            if(k.includes('LETHAL') || k.includes('SUSTAINED')) return `<span class="k-lethal">${k}</span>`;
            if(k.includes('ANTI') || k.includes('DEV')) return `<span class="k-anti">${k}</span>`;
            if(k.includes('BLAST') || k.includes('TORRENT') || k.includes('INDIRECT')) return `<span class="k-blast">${k}</span>`;
            return k;
        }).join(', ');
    }

    document.getElementById('next-phase-btn').onclick = () => {
        currentPhaseIndex = (currentPhaseIndex + 1) % PHASES.length;
        document.getElementById('current-phase-name').innerText = PHASES[currentPhaseIndex].label;
        if(activeId !== 'rules') loadView(activeId); // Refresh for phase highlights
    };

    // Start
    loadView('rules');

</script>
</body>
</html>
